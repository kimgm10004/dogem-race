<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>ë„íŠ¸ ê²½ë§ˆ v4.5 â€” ì‹¤í™©/ê±°ë¦¬ìŠ¤ì¼€ì¼/ë‚ ì”¨/íƒ€ì… + ìë™í¸ì„± + ë¦¬ì–¼ ì‚¬ìš´ë“œ + Firebase</title>
<style>
  :root { --bg:#0b0e16; --panel:#0f1424; --line:#1f2940; --text:#c8d0ff; --title:#ffffff; --accent:#6C5CE7; --good:#9df7c7; --warn:#ffd26e; --bad:#ff7a9e; }
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
  .wrap{max-width:1120px;margin:0 auto;padding:14px}
  h1{margin:0 0 10px;color:var(--title);font-size:20px}
  .grid{display:grid;grid-template-columns:600px 1fr;gap:12px}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:10px;padding:10px}
  canvas{width:100%;height:auto;display:block;image-rendering:pixelated;border-radius:8px;border:1px solid var(--line)}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .row>*{flex:1 1 auto}
  .pill{padding:6px 10px;border-radius:999px;background:#131a33;border:1px solid #1f2940;font-size:12px}
  .money{font-weight:700;color:var(--warn)}
  button{background:var(--accent);color:#fff;border:0;border-radius:8px;padding:8px 12px;cursor:pointer}
  button.secondary{background:#1e2a53;color:#dbe1ff}
  button.ghost{background:transparent;border:1px solid var(--line);color:#dbe1ff}
  button:disabled{opacity:.6;cursor:not-allowed}
  select,input[type=number],input[type=email],input[type=password],input[type=text]{padding:8px 10px;border-radius:8px;border:1px solid #2a3557;background:#0d1330;color:#dbe1ff}
  table{width:100%;border-collapse:collapse;font-size:12px}
  th,td{border-bottom:1px dashed var(--line);padding:6px 8px;text-align:center;white-space:nowrap}
  th{color:#9fb0ff}
  .badge{display:inline-block;padding:2px 6px;border-radius:999px;font-size:11px;border:1px solid var(--line);background:#111729}
  .lane{display:inline-block;width:16px;height:16px;border-radius:4px;margin-right:6px;vertical-align:middle}
  .ticket{background:#0e1531;border:1px solid var(--line);padding:8px;border-radius:8px;margin:6px 0;font-size:12px}
  .small{font-size:12px}
  .right{text-align:right}
  .hint{font-size:12px;opacity:.75;margin-top:8px}
  .odds{font-variant-numeric:tabular-nums}
  .hr{height:1px;background:var(--line);margin:8px 0}
  .tag{display:inline-block;padding:2px 6px;border-radius:6px;border:1px solid var(--line);background:#141a33}
  .totals{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}

  /* ì¶©ì „ ëª¨ë‹¬ */
  .modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,20,0.55); z-index:9999; }
  .modal .box { width:min(520px, 92vw); background:#0f1424; border:1px solid #1f2940; border-radius:12px; padding:14px; }
  .modal .row { margin-top:8px; }

  /* ë§ë²ˆí˜¸ ì…ë ¥ í•˜ì´ë¼ì´íŠ¸ */
  .hl { border-color:#ff6b6b !important; box-shadow:0 0 0 2px rgba(255,107,107,.25); }
</style>
</head>
<body>
<div class="wrap">
  <h1>ë„íŠ¸ ê²½ë§ˆ v4.5</h1>

  <div class="grid">
    <div class="panel">
      <canvas id="game"></canvas>

      <div class="row" style="margin-top:8px;">
        <button id="btnNew" class="secondary">ë‹¤ìŒ ê²½ì£¼ í¸ì„±</button>
        <button id="btnStart">ì¶œë°œ!</button>
        <button id="btnSound" class="ghost">ğŸ”Š ì‚¬ìš´ë“œ ì¼œê¸°</button>
        <button id="btnCharge" class="ghost">ì¶©ì „í•˜ê¸°</button>
        <div class="pill">ê²½ì£¼ë²ˆí˜¸ <span id="raceNo">1</span></div>
        <div class="pill">ìƒíƒœ <span id="phaseText">ë² íŒ… ì˜¤í”ˆ</span> Â· <span id="countdown">--</span>s</div>
        <div class="pill">ê±°ë¦¬ <span id="raceMeters">-</span>m</div>
        <div class="pill">ì¶œì „ <span id="fieldSize">-</span>ë‘</div>
        <div class="pill">ì§€ê°‘ <span id="wallet" class="money">0</span> ì›</div>
      </div>

      <!-- ë¡œê·¸ì¸ ë°•ìŠ¤ -->
      <div id="authBox" class="row" style="margin-top:8px;">
        <input id="email" type="email" placeholder="ì´ë©”ì¼" />
        <input id="password" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" />
        <button id="btnSignup" class="ghost">íšŒì›ê°€ì…</button>
        <button id="btnLogin" class="ghost">ë¡œê·¸ì¸</button>
        <button id="btnLogout" class="ghost" style="display:none;">ë¡œê·¸ì•„ì›ƒ</button>
        <span id="authHint" class="small right" style="opacity:.8;"></span>
      </div>

      <div class="hint">ì‹¤í™© ì¤‘ê³„ ê°•í™”: â€œí˜„ì¬ 1ë²ˆ 1ìœ„, 3ë²ˆ 2ìœ„...â€ / ê³¨ì¸ ë©˜íŠ¸: â€œê³¨ì¸! 1ë²ˆ 1ë“±, 2ë²ˆ 2ë“±, 3ë²ˆ 3ë“±â€ í‘œì‹œ!</div>
    </div>

    <div class="panel">
      <div class="row">
        <div class="pill">í…Œì´í¬ì•„ì›ƒ 18%</div>
        <div class="pill">ì˜ˆìƒ ë°°ë‹¹ì€ í˜„ì¬ í’€ ê¸°ì¤€</div>
      </div>
      <div class="totals small" id="poolTotals"></div>
      <div class="hr"></div>

      <table id="tbl">
        <thead>
          <tr>
            <th>ë²ˆ</th><th>ë§ˆëª…</th><th>ê¸°ìˆ˜</th>
            <th>ì†ë ¥</th><th>ì§€êµ¬ë ¥</th><th>ìŠ¤í¼íŠ¸</th><th>ìˆ™ë ¨</th><th>ë ˆì´íŒ…</th>
            <th>ë‹¨ìŠ¹</th><th>ì—°ìŠ¹</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="hr"></div>

      <div class="row">
        <select id="betType">
          <option value="WIN">ë‹¨ìŠ¹ì‹ (1ì°©)</option>
          <option value="PLACE">ì—°ìŠ¹ì‹ (3ìœ„ ë‚´)</option>
          <option value="QUINELLA">ë³µìŠ¹ì‹ (1Â·2ì°© ë¬´ìˆœ)</option>
          <option value="EXACTA">ìŒìŠ¹ì‹ (1Â·2ì°© ìˆœì„œì¼ì¹˜)</option>
          <option value="PLACEQ">ë³µì—°ìŠ¹ì‹ (ë‘ ë§ ëª¨ë‘ 3ìœ„ ë‚´)</option>
          <option value="TRIO">ì‚¼ë³µìŠ¹ì‹ (1~3ì°© ë¬´ìˆœ)</option>
          <option value="TRIFECTA">ì‚¼ìŒìŠ¹ì‹ (1~3ì°© ìˆœì„œì¼ì¹˜)</option>
        </select>
        <input id="pickA" type="number" min="1" value="1" placeholder="ë§1" />
        <input id="pickB" type="number" min="1" value="2" placeholder="ë§2(í•„ìš”)" />
        <input id="pickC" type="number" min="1" value="3" placeholder="ë§3(í•„ìš”)" />
        <input id="amount" type="number" min="100" step="100" value="1000" />
        <button id="btnAdd">ë² íŒ… ì¶”ê°€</button>
      </div>
      <div class="hint">ë² íŒ… íƒ€ì…ë³„ë¡œ í•„ìš”í•œ ë§ ë²ˆí˜¸ ì¹¸ì´ ë¹¨ê°„ìƒ‰ìœ¼ë¡œ í•˜ì´ë¼ì´íŠ¸ë¼ìš”.</div>

      <div id="tickets"></div>
    </div>
  </div>

  <div class="panel" style="margin-top:12px;">
    <div class="row">
      <div class="pill">ê²°ê³¼</div>
      <div id="resultText"></div>
    </div>
    <div id="payouts" class="small" style="margin-top:8px;"></div>
    <div id="commentary" class="small" style="margin-top:8px;opacity:.9"></div>
  </div>

  <div class="panel" style="margin-top:12px;">
    <div class="row">
      <div class="pill">íˆìŠ¤í† ë¦¬</div>
      <div class="pill">ìµœê·¼ 10ê²½ì£¼</div>
      <div class="pill">ì´ ì†ìµ <span id="roi" class="money">0</span> ì›</div>
    </div>
    <div id="history" class="small" style="margin-top:8px;"></div>
  </div>

  <!-- ì¶©ì „ ëª¨ë‹¬ -->
  <div id="chargeModal" class="modal">
    <div class="box">
      <div class="row">
        <div class="pill">ì¶©ì „í•˜ê¸°</div>
        <div class="right"><button id="btnCloseCharge" class="ghost">ë‹«ê¸°</button></div>
      </div>
      <div class="row">
        <button id="btnDaily" class="secondary">ì˜¤ëŠ˜ì˜ ë³´ë„ˆìŠ¤ ë°›ê¸° (+10,000)</button>
        <span id="dailyHint" class="small" style="opacity:.85;"></span>
      </div>
      <div class="row" style="gap:6px;">
        <input id="couponInput" type="text" placeholder="ì¿ í° ì½”ë“œ ì…ë ¥(ì˜ˆ: TEST10K)" />
        <button id="btnCoupon" class="ghost">ì¿ í° ì‚¬ìš©</button>
        <span id="couponHint" class="small" style="opacity:.85;"></span>
      </div>
      <div class="hint">ê´‘ê³  í´ë¦­ ë³´ìƒì€ ì •ì±… ìœ„ë°˜ ìœ„í—˜ì´ë¼ ì œê³µí•˜ì§€ ì•Šì•„ìš”. ì¶œì„/ì¿ í°/ë¯¸ì…˜ ë³´ìƒìœ¼ë¡œ ì•ˆì „í•˜ê²Œ ìš´ì˜!</div>
    </div>
  </div>

  <div class="hint">Â© ë„ê²€ìœ íŠ¸ë¸Œ â€” ì´ íŒŒì¼ í•˜ë‚˜ë¡œ ë°°í¬ í›„ í‹°ìŠ¤í† ë¦¬ì— iframeìœ¼ë¡œ ì„ë² ë“œí•˜ë©´ ë!</div>
</div>

<!-- ê²Œì„ ìŠ¤í¬ë¦½íŠ¸(ë¹„ëª¨ë“ˆ) -->
<script>
(()=> {
/* ===== ê¸°ë³¸ ìƒìˆ˜/ìœ í‹¸ ===== */
const TAKE = 0.18;
const COLORS = ['#ff6b6b','#feca57','#1dd1a1','#5f27cd','#54a0ff','#ff9ff3','#48dbfb','#576574','#c8d6e5','#ffaf40','#10ac84','#ee5253'];

const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const SCALE = 3;
const W = 380, H = 280;
canvas.width = W*SCALE; canvas.height = H*SCALE;
ctx.imageSmoothingEnabled = false;

const CX=W/2, CY=H/2+6, RX=140, RY=70, LANE_W=6, FINISH_ANG=0;

const rand=(a,b)=>a+Math.random()*(b-a);
const rint=(a,b)=>Math.floor(rand(a,b+1));
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const choice=arr=>arr[Math.floor(Math.random()*arr.length)];
const fmt=v=>v.toLocaleString('ko-KR');
const fmtOdds=v=>isFinite(v)?v.toFixed(1):'-';
const inRange=(v,a,b)=>v>=a&&v<=b;
const sortedKey=(...xs)=>xs.slice().sort((a,b)=>a-b).join('-');

/* ===== DOM ===== */
const tblBody=document.querySelector('#tbl tbody');
const poolTotalsEl=document.getElementById('poolTotals');
const walletEl=document.getElementById('wallet');
const raceNoEl=document.getElementById('raceNo');
const fieldSizeEl=document.getElementById('fieldSize');
const raceMetersEl=document.getElementById('raceMeters');
const ticketsEl=document.getElementById('tickets');
const resultEl=document.getElementById('resultText');
const payoutsEl=document.getElementById('payouts');
const phaseText=document.getElementById('phaseText');
const countdownEl=document.getElementById('countdown');
const historyEl=document.getElementById('history');
const roiEl=document.getElementById('roi');
const btnNew=document.getElementById('btnNew');
const btnStart=document.getElementById('btnStart');
const btnAdd=document.getElementById('btnAdd');
const btnSound=document.getElementById('btnSound');
const btnCharge=document.getElementById('btnCharge');
const selType=document.getElementById('betType');
const pickA=document.getElementById('pickA');
const pickB=document.getElementById('pickB');
const pickC=document.getElementById('pickC');
const amount=document.getElementById('amount');
const commentaryEl=document.getElementById('commentary');

const chargeModal=document.getElementById('chargeModal');
const btnCloseCharge=document.getElementById('btnCloseCharge');
const btnDaily=document.getElementById('btnDaily');
const dailyHint=document.getElementById('dailyHint');
const btnCoupon=document.getElementById('btnCoupon');
const couponInput=document.getElementById('couponInput');
const couponHint=document.getElementById('couponHint');

/* ===== ì €ì¥/ì´ˆê¸° ===== */
let wallet=Number(localStorage.getItem('wallet')||100000);
let raceNo=Number(localStorage.getItem('raceNo')||1);
let roiTotal=Number(localStorage.getItem('roiTotal')||0);
walletEl.textContent=fmt(wallet);
raceNoEl.textContent=raceNo;
roiEl.textContent=fmt(roiTotal);

/* ===== ë¦¬ì–¼ ì‚¬ìš´ë“œ ===== */
let audioCtx=null, soundEnabled=false;
let bufGun=null, bufGallop=null, bufCrowd=null;
let gallopSrc=null, gallopGain=null;
let crowdSrc=null, crowdGain=null;
let sfxLoaded=false;

const ASSET = {
  gun: ['assets/audio/gunshot.mp3','assets/audio/gunshot.ogg'],
  gallop: ['assets/audio/gallop_loop.ogg','assets/audio/gallop_loop.mp3'],
  crowd: ['assets/audio/crowd_loop.ogg','assets/audio/crowd_loop.mp3']
};

function getCtx(){ if(!soundEnabled) return null; if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)(); if(audioCtx.state==='suspended') audioCtx.resume(); return audioCtx; }
async function fetchAsBuffer(url){ const res=await fetch(url,{mode:'cors'}); if(!res.ok) throw new Error('fetch fail '+url); const arr=await res.arrayBuffer(); const ctx=getCtx(); return await ctx.decodeAudioData(arr); }
async function loadFirstAvailable(list){ for(const url of list){ try{ return await fetchAsBuffer(url);}catch(e){} } throw new Error('no playable src'); }
async function loadSfxOnce(){ if(sfxLoaded||!soundEnabled) return; try{ [bufGun,bufGallop,bufCrowd]=await Promise.all([loadFirstAvailable(ASSET.gun),loadFirstAvailable(ASSET.gallop),loadFirstAvailable(ASSET.crowd)]); sfxLoaded=true; }catch(e){ console.warn('SFX load failed:',e);} }
function setSound(on){ soundEnabled=on; btnSound.textContent=on?'ğŸ”‡ ì‚¬ìš´ë“œ ë„ê¸°':'ğŸ”Š ì‚¬ìš´ë“œ ì¼œê¸°'; if(!on){ stopGallop(); stopCrowd(); } if(on){ getCtx(); loadSfxOnce(); } }
btnSound.onclick=()=>setSound(!soundEnabled);
canvas.addEventListener('pointerdown',()=>{ if(soundEnabled){ getCtx(); loadSfxOnce(); } });
btnStart.addEventListener('click',()=>{ if(soundEnabled){ getCtx(); loadSfxOnce(); } });

function playGunShot(){ if(!soundEnabled||!bufGun) return; const ctx=getCtx(); if(!ctx) return; const src=ctx.createBufferSource(); const g=ctx.createGain(); g.gain.value=0.9; src.buffer=bufGun; src.connect(g).connect(ctx.destination); src.start(); }
function startGallop(){ if(!soundEnabled||gallopSrc||!bufGallop) return; const ctx=getCtx(); if(!ctx) return; gallopSrc=ctx.createBufferSource(); gallopSrc.buffer=bufGallop; gallopSrc.loop=true; gallopGain=ctx.createGain(); gallopGain.gain.value=0.28; gallopSrc.connect(gallopGain).connect(ctx.destination); gallopSrc.start(); }
function stopGallop(){ if(!gallopSrc) return; try{ const ctx=getCtx(); gallopGain.gain.cancelScheduledValues(ctx.currentTime); gallopGain.gain.exponentialRampToValueAtTime(0.0001,ctx.currentTime+0.5); gallopSrc.stop(ctx.currentTime+0.55);}catch(_){} gallopSrc=null; gallopGain=null; }
function startCrowd(level=0.2){ if(!soundEnabled||crowdSrc||!bufCrowd) return; const ctx=getCtx(); if(!ctx) return; crowdSrc=ctx.createBufferSource(); crowdSrc.buffer=bufCrowd; crowdSrc.loop=true; crowdGain=ctx.createGain(); crowdGain.gain.value=0.0001; crowdSrc.connect(crowdGain).connect(ctx.destination); crowdSrc.start(); fadeCrowd(level,0.8); }
function fadeCrowd(level=0.3,sec=0.6){ if(!crowdGain) return; const ctx=getCtx(); if(!ctx) return; const now=ctx.currentTime; crowdGain.gain.cancelScheduledValues(now); crowdGain.gain.setValueAtTime(Math.max(0.0001,crowdGain.gain.value),now); crowdGain.gain.exponentialRampToValueAtTime(Math.max(0.0001,level),now+sec); }
function stopCrowd(){ if(!crowdSrc||!crowdGain) return; try{ const ctx=getCtx(); const now=ctx.currentTime; crowdGain.gain.cancelScheduledValues(now); crowdGain.gain.exponentialRampToValueAtTime(0.0001,now+0.6); crowdSrc.stop(now+0.7);}catch(_){} crowdSrc=null; crowdGain=null; }

/* ===== ë‚ ì”¨ ===== */
let weather = { kind:'ë§‘ìŒ', icon:'â˜€ï¸', wet:false, snow:false };
function rollWeather(){
  const r=Math.random();
  if (r<0.15) return {kind:'ë¹„', icon:'ğŸŒ§ï¸', wet:true, snow:false};
  if (r<0.22) return {kind:'ëˆˆ', icon:'â„ï¸', wet:false, snow:true};
  return {kind:'ë§‘ìŒ', icon:'â˜€ï¸', wet:false, snow:false};
}

/* ===== ê²Œì„ ìƒíƒœ ===== */
const namesA=['ì€í•˜','í­í’','ë‹¬ë¹›','ì²œë‘¥','ìœ ë‹ˆ','ë¸”ë ˆì´ì¦ˆ','ë‹¤í¬','ì´ˆì‹ ì„±','ìŠ¤í…”ë¼','ë¼ì´íŠ¸','ì œíŠ¸','ë¦°ë“œ'];
const namesB=['ìŠ¤í…','ëŸ°','ìœˆë“œ','ë¸”ë¦¬ì¸ ','ì• ë¡œìš°','í•˜ëª¨ë‹ˆ','ì›¨ì´ë¸Œ','ìŠ¤íŒŒí¬','í”¼ë‹‰ìŠ¤','ë ˆì¸','í—¤ì¼ë¡œ','ìŠ¤í”¼ë¦¿'];
const jockeyA=['ë°•','ê¹€','ì´','ìµœ','ì •','í•œ','ìœ¤','ì„','ì¥','ì„œ','ìœ ','ë¬¸','ì•ˆ','ë„','ë…¸','ì†¡'];
const jockeyB=['í˜„ìš°','ì§€í›ˆ','ë¯¼ìˆ˜','ì„œì—°','ë„ìœ¤','í•˜ì¤€','ì˜ˆë¦°','ì§€í˜¸','ì„œìœ¤','íƒœí˜„','ì‹œìš°','í•˜ë¦°','ë³´ë¯¸','ìœ ì§„','ê°€ìœ¤','ë¯¼ì¬'];

let roster=[], pools, userTickets=[], history=JSON.parse(localStorage.getItem('history')||'[]');
let phase='betting'; // betting -> closing -> parade -> running -> result -> intermission
let countdown=30, aiFlowTimer=0;
let running=false, paradeTimer=0, finishedOrder=[], time=0;
let raceMeters=1200; const lapMeters=1600; let startAng=0;
let nextRaceTimer = 0;       // ì¸í„°ë¯¸ì…˜ ms ì¹´ìš´íŠ¸
let intermissionHint = '';   // HUD í‘œê¸°
let lastCastTick = 0;        // ì‹¤ì‹œê°„ ìˆœìœ„ ë©˜íŠ¸ ì£¼ê¸°

/* ===== ì‹¤í™© ì¤‘ê³„ í”Œë˜ê·¸ ===== */
let castFlags = { q1:false, q2:false, q3:false };
let lastLeader = null;
function addCast(line){
  const lines = commentaryEl.innerHTML.split('<br>').filter(Boolean);
  lines.push(`Â· ${line}`);
  while (lines.length > 8) lines.shift();
  commentaryEl.innerHTML = lines.join('<br>');
}

/* ===== ì§€ê°‘ ë¸Œë¦¬ì§€ ===== */
window.gameWallet = {
  setFromCloud(value){
    wallet = Math.max(0, Number(value)||0);
    walletEl.textContent = fmt(wallet);
    localStorage.setItem('wallet', wallet);
  }
};
function handleWallet(delta){
  if (window.firebaseWallet?.add){
    window.firebaseWallet.add(delta);
  } else {
    wallet = Math.max(0, wallet + delta);
    walletEl.textContent = fmt(wallet);
    localStorage.setItem('wallet', wallet);
  }
}

/* ===== ì´ˆê¸°í™” ===== */
renderHistory();
newRace();

/* ===== ë² íŒ… ë§ë²ˆí˜¸ í•˜ì´ë¼ì´íŠ¸ ===== */
const betTypeEl = document.getElementById('betType');
function refreshPickHighlight(){
  [pickA, pickB, pickC].forEach(el => el.classList.remove('hl'));
  const t = betTypeEl.value;
  if (t==='WIN' || t==='PLACE') pickA.classList.add('hl');
  else if (t==='QUINELLA' || t==='EXACTA' || t==='PLACEQ') { pickA.classList.add('hl'); pickB.classList.add('hl'); }
  else if (t==='TRIO' || t==='TRIFECTA') { pickA.classList.add('hl'); pickB.classList.add('hl'); pickC.classList.add('hl'); }
}
betTypeEl.addEventListener('change', refreshPickHighlight);
['input','change'].forEach(ev=>{
  pickA.addEventListener(ev, ()=> pickA.classList.toggle('hl', !!pickA.value));
  pickB.addEventListener(ev, ()=> pickB.classList.toggle('hl', !!pickB.value));
  pickC.addEventListener(ev, ()=> pickC.classList.toggle('hl', !!pickC.value));
});
refreshPickHighlight();

/* ===== ì…ë ¥ ===== */
btnAdd.onclick=()=>{
  if (!(phase==='betting'||phase==='closing')) return alert('ì§€ê¸ˆì€ ë² íŒ…ì´ ë§ˆê°ë˜ì—ˆì–´!');
  const type=selType.value;
  const a=Number(pickA.value)-1, b=Number(pickB.value)-1, c=Number(pickC.value)-1;
  const amt=Math.max(100, Math.floor(Number(amount.value)/100)*100);
  if (!amt||wallet<amt) return alert('ë² íŒ… ê¸ˆì•¡ í™•ì¸!');
  const N=roster.length;

  if (type==='WIN'||type==='PLACE'){
    if(!inRange(a,0,N-1)) return alert('ë§ ë²ˆí˜¸ í™•ì¸!');
    addUserPool(type,a,null,amt); userTickets.push({type,a,amount:amt});
  } else if (type==='QUINELLA'||type==='EXACTA'||type==='PLACEQ'){
    if(!inRange(a,0,N-1)||!inRange(b,0,N-1)||a===b) return alert('ë‘ ë§ ë²ˆí˜¸ í™•ì¸!');
    addUserPool(type,a,b,amt); userTickets.push({type,a,b,amount:amt});
  } else if (type==='TRIO'||type==='TRIFECTA'){
    if (![a,b,c].every(v=>inRange(v,0,N-1))) return alert('ì„¸ ë§ ë²ˆí˜¸ í™•ì¸!');
    if (a===b||a===c||b===c) return alert('ì„œë¡œ ë‹¤ë¥¸ ë§ë¡œ ê³ ë¥´ê¸°!');
    addUserPool(type,a,b,amt,c); userTickets.push({type,a,b,c,amount:amt});
  }
  handleWallet(-amt);
  rebuildTickets(); renderPayoutPreview(); renderPoolTotals();
};
btnStart.onclick=()=>{ if(phase==='running'||phase==='parade'||phase==='intermission') return; startRace(); };
btnNew.onclick=()=>{
  if (phase==='running'||phase==='parade'){
    if(!confirm('ì§„í–‰ ì¤‘ì¸ ê²½ì£¼ë¥¼ í¬ê¸°í•˜ê³  ìƒˆë¡œ í¸ì„±í• ê¹Œìš”?')) return;
  }
  raceNo += 1; raceNoEl.textContent=raceNo; localStorage.setItem('raceNo',raceNo);
  newRace();
};
btnCharge.onclick=()=>{ chargeModal.style.display='flex'; };
btnCloseCharge.onclick=()=>{ chargeModal.style.display='none'; };

/* ===== ê²½ì£¼ íë¦„ ===== */
function newRace(){
  phase='betting'; phaseText.textContent='ë² íŒ… ì˜¤í”ˆ'; countdown=30; countdownEl.textContent=countdown;
  running=false; paradeTimer=0; finishedOrder.length=0; time=0; lastCastTick=0;
  resultEl.textContent=''; payoutsEl.innerHTML=''; commentaryEl.innerHTML='';
  userTickets=[]; rebuildTickets();
  stopGallop(); stopCrowd();

  // ë‚ ì”¨
  weather = rollWeather();

  // ì‹¤í™© í”Œë˜ê·¸ ì´ˆê¸°í™”
  castFlags = { q1:false, q2:false, q3:false };
  lastLeader = null;
  addCast(`ì˜¤ëŠ˜ ë‚ ì”¨ëŠ” ${weather.icon} ${weather.kind} ì…ë‹ˆë‹¤.`);

  const cand=[800,1000,1100,1200,1400,1500,1600,1800,2000];
  raceMeters = choice(cand); raceMetersEl.textContent=raceMeters;

  const N=rint(8,12);
  const types = ['ì„ í–‰','ì„ ì…','ì¶”ì…','ììœ '];
  function pickType(){
    const r = Math.random();
    if (r < 0.30) return 'ì„ í–‰';
    if (r < 0.65) return 'ì„ ì…';
    if (r < 0.90) return 'ì¶”ì…';
    return 'ììœ ';
  }

  roster = Array.from({length:N}, (_,i)=>{
    const speed=rint(60,99), stamina=rint(55,95), burst=rint(50,98), jockeySkill=rint(60,98);
    const horseCond=rand(0.88,1.12), jockeyCond=rand(0.90,1.10);
    const name=choice(namesA)+choice(namesB), jockey=choice(jockeyA)+choice(jockeyB);
    const rating=Math.round(speed*0.5 + stamina*0.3 + burst*0.15 + jockeySkill*0.2);
    const type = pickType();
    return { no:i+1, color:COLORS[i%COLORS.length], name, jockey, speed,stamina,burst,jockeySkill,rating,
             horseCond,jockeyCond, dist:0, finished:false, finishTime:null, stumble:0, type };
  });
  fieldSizeEl.textContent=roster.length;

  const lap=2*Math.PI;
  startAng = normAngle(FINISH_ANG - lap*(raceMeters/lapMeters));

  renderTable();
  pools = makePools(roster);
  renderPayoutPreview(); renderPoolTotals();
  syncControls();
}
function startRace(){
  phase='parade'; phaseText.textContent='ì¶œë°œ ì¤€ë¹„';
  paradeTimer=3*60; countdown=0; countdownEl.textContent='0';
  running=false;
  if (soundEnabled){ getCtx(); loadSfxOnce(); startCrowd(0.18); }
  syncControls();
}
function beginRunning(){
  phase='running'; phaseText.textContent='ê²½ì£¼ ì¤‘'; running=true;
  if (soundEnabled){ playGunShot(); startGallop(); fadeCrowd(0.35,0.8); }
  syncControls();
}
function finishRace(){
  running=false; phase='result'; phaseText.textContent='ê²°ê³¼'; syncControls();
  if (soundEnabled){ stopGallop(); fadeCrowd(0.55,0.6); setTimeout(()=>fadeCrowd(0.2,1.2),1200); }

  const order=[...finishedOrder];
  const first=order[0], second=order[1], third=order[2];
  const nm=i=>`${roster[i].no}-${roster[i].name}`;
  resultEl.innerHTML = `<b>ë„ì°©</b> â–¶ 1ìœ„ ${nm(first)} / 2ìœ„ ${nm(second)} / 3ìœ„ ${nm(third)}`;

  const pay=computePayouts(order);
  showPayouts(pay, order);
  renderPayoutDetails(pay, order);

  const totalBet=userTickets.reduce((s,t)=>s+t.amount,0);
  let totalReturn=0; const lines=[];
  userTickets.forEach(t=>{
    const ret=settleTicket(t,order,pay); totalReturn+=ret;
    lines.push(`â€¢ ${descTicket(t)} â†’ ${ret>0?('ì ì¤‘ '+fmt(Math.floor(ret))+'ì›'):'ë¯¸ì ì¤‘'}`);
  });
  if (totalReturn>0){ handleWallet(Math.floor(totalReturn)); }
  const pnl=Math.floor(totalReturn-totalBet); roiTotal+=pnl; roiEl.textContent=fmt(roiTotal); localStorage.setItem('roiTotal',roiTotal);
  payoutsEl.innerHTML += `<div class="hr"></div><div class="small">${lines.join('<br>')}</div>`;

  history.unshift({ raceNo, time:new Date().toLocaleString(), order:order.slice(0,3),
    pnl, totalBet, totalReturn, meters:raceMeters, field:roster.length });
  if (history.length>10) history.pop();
  localStorage.setItem('history', JSON.stringify(history));
  renderHistory();

  // ê³¨ì¸ ë©˜íŠ¸
  const top3 = order.slice(0,3).map(i=>roster[i].no);
  addCast(`ê³¨ì¸! ${top3[0]}ë²ˆ 1ë“±, ${top3[1]}ë²ˆ 2ë“±, ${top3[2]}ë²ˆ 3ë“±ì…ë‹ˆë‹¤!`);

  // ì¸í„°ë¯¸ì…˜(60ì´ˆ) â†’ ìë™ ë‹¤ìŒ ê²½ì£¼
  phase = 'intermission';
  phaseText.textContent = 'ì¸í„°ë¯¸ì…˜';
  nextRaceTimer = 60 * 1000; // 60ì´ˆ
  intermissionHint = 'ë‹¤ìŒ ê²½ì£¼ í¸ì„±ê¹Œì§€ 01:00';
}

/* ===== 60fps ë£¨í”„ ===== */
requestAnimationFrame(loop);
function loop(ts){
  let delta=ts-last; last=ts; if(delta>250) delta=250;
  acc+=delta; while(acc>=1000/60){ update(1000/60); acc-=1000/60; }
  draw(); requestAnimationFrame(loop);
}
function update(FIXED){
  if (phase==='betting'||phase==='closing'){
    aiFlowTimer++;
    if (aiFlowTimer%60===0){
      if (countdown>0) countdown--; countdownEl.textContent=countdown;
      aiRandomFlow(); renderPayoutPreview(); renderPoolTotals();
      if (phase==='betting' && countdown<=10){ phase='closing'; phaseText.textContent='ë§ˆê° ì„ë°•'; syncControls(); }
      if (countdown<=0){ startRace(); }
    }
  }

  // ì¸í„°ë¯¸ì…˜
  if (phase==='intermission'){
    nextRaceTimer -= FIXED;
    if (nextRaceTimer < 0) nextRaceTimer = 0;
    const sec = Math.ceil(nextRaceTimer/1000);
    const m = String(Math.floor(sec/60)).padStart(2,'0');
    const s = String(sec%60).padStart(2,'0');
    intermissionHint = `ë‹¤ìŒ ê²½ì£¼ í¸ì„±ê¹Œì§€ ${m}:${s}`;
    if (nextRaceTimer === 0) newRace();
    return;
  }

  if (phase==='parade'){
    paradeTimer--; if (paradeTimer<=0){ beginRunning(); }
    return;
  }
  if (!running) return;

  time++;

  // ì´ë™/ë¬¼ë¦¬
  roster.forEach((r)=>{
    if (r.finished) return;

    // ê±°ë¦¬ ìŠ¤ì¼€ì¼(1200m ê¸°ì¤€): ì§§ìœ¼ë©´ ë¹ ë¥´ê²Œ, ê¸¸ë©´ ëŠë¦¬ê²Œ
    const distScale = clamp(1200 / raceMeters, 0.6, 1.4);

    const prog=r.dist/raceMeters;
    // íƒ€ì… ê°€ì¤‘ì¹˜
    let typeMul=1;
    if (r.type==='ì„ í–‰') typeMul *= (prog<0.5?1.06:0.96);
    else if (r.type==='ì„ ì…') typeMul *= 1.02;
    else if (r.type==='ì¶”ì…') typeMul *= (prog<0.6?0.96:1.08);

    const base=0.9 + r.speed/120;
    let cond=r.horseCond*r.jockeyCond;
    let fatigue=clamp(1 - (prog*(1.2 - r.stamina/100)), 0.70, 1.03);
    let kick=(prog>0.82)?(1 + (r.burst/100)*0.38):1;
    const jitter=rand(0.985,1.015);

    // ë‚ ì”¨ ë³´ì •(ë¹„/ëˆˆ)
    if (weather.wet){ fatigue *= 0.98; kick *= 0.98; }
    if (weather.snow){ cond *= 0.98; }

    // ì –ì€ íŠ¸ë™ ì ì„±(ëŒ€ëµ): ì²´ë ¥+ìˆ™ë ¨ í‰ê· ì¹˜ë¡œ +3% ì´ë‚´ ë³´ì •
    if (weather.wet){
      const wetTalent = (r.stamina + r.jockeySkill)/200; // 0~1
      cond *= (0.98 + wetTalent*0.03);
    }

    // ì‹¤ìˆ˜ ì´ë²¤íŠ¸
    if (r.stumble<=0 && Math.random()<0.0117) r.stumble=rint(30,70);
    const stumbleMul=(r.stumble>0)?0.68:1;
    if (r.stumble>0) r.stumble--;

    // ì½”ë„ˆ ê°ì†
    const theta=angleFromDist(r.dist);
    let cornerMul=1.0; cornerMul *= 0.96 + 0.04*(1-Math.abs(Math.sin(theta)));

    // ìµœì¢… ì†ë„(ì˜¤íƒ€ ìˆ˜ì •: ì „ë¶€ ê³±ì…ˆ)
    let v=base*cond*fatigue*kick*jitter*stumbleMul*cornerMul*typeMul;
    // ê±°ë¦¬ ìŠ¤ì¼€ì¼ ë°˜ì˜
    v *= 0.9 + distScale*0.2;

    r.dist += v;

    if (r.dist>=raceMeters){
      r.dist=raceMeters; r.finished=true; r.finishTime=time;
      finishedOrder.push(roster.indexOf(r));
    }
  });

  // ì‹¤í™©: ì„ ë‘/êµ¬ê°„/ì‹¤ìˆ˜/ì‹¤ì‹œê°„ ìˆœìœ„ ë©˜íŠ¸
  const orderNow = [...roster].map((r,idx)=>({idx,dist:r.dist})).sort((a,b)=>b.dist-a.dist).map(o=>o.idx);
  const leader = orderNow[0];
  if (lastLeader === null) lastLeader = leader;
  const leadDist = roster[leader].dist;

  if (!castFlags.q1 && leadDist >= raceMeters*0.25){ castFlags.q1=true; addCast('1/4 êµ¬ê°„ í†µê³¼! ì„ ë‘ ê·¸ë£¹ ë¹ ë¥´ê²Œ ì „ê°œ!'); }
  if (!castFlags.q2 && leadDist >= raceMeters*0.50){ castFlags.q2=true; addCast('ì¤‘ë°˜ ì§„ì…! ì„ ë‘ê¶Œ ì´˜ì´˜, ì§ì„  ìŠ¹ë¶€ ì¤€ë¹„!'); }
  if (!castFlags.q3 && leadDist >= raceMeters*0.75){ castFlags.q3=true; addCast('3/4 ì§€ì ! ìŠ¤í¼íŠ¸ ì¤€ë¹„, ê²°ìŠ¹ì„  í–¥í•´ ì§„ì…!'); }
  if (leader !== lastLeader){ addCast(`ì„ ë‘ ë°”ë€ë‹ˆë‹¤! #${roster[leader].no} ${roster[leader].name} ì•ìœ¼ë¡œ!`); lastLeader=leader; }
  for (const r of roster){ if (r.stumble===1){ addCast(`ì•„! #${r.no} ${r.name} ì•½ê°„ì˜ ì‹¤ìˆ˜! ì†ë„ ë–¨ì–´ì§‘ë‹ˆë‹¤!`); break; } }

  // 1ì´ˆ ê°„ê²© ì‹¤ì‹œê°„ ìˆœìœ„ ë©˜íŠ¸
  lastCastTick += FIXED;
  if (lastCastTick >= 1000) {
    lastCastTick = 0;
    const top = orderNow.slice(0,3).map(i=>roster[i].no);
    if (top.length>=2) addCast(`í˜„ì¬ ${top[0]}ë²ˆ 1ìœ„, ${top[1]}ë²ˆ 2ìœ„${top[2]?`, ${top[2]}ë²ˆ 3ìœ„`:''}!`);
  }

  if (finishedOrder.length===roster.length){ finishRace(); }
}

/* ===== AI ë² íŒ… ìœ ì… ===== */
function aiRandomFlow(){
  const weights=roster.map(r=>r.rating);
  const add=()=>Math.floor(rand(200,4000));
  const pickW=()=>weightedPick(weights);
  for(let t=0;t<rint(2,5);t++){
    const i=pickW(); pools.win[i].amount+=add(); pools.place[i].amount+=Math.floor(add()*0.8);
  }
  for(let t=0;t<rint(1,3);t++){
    const i=pickW(); let j=pickW(); while(j===i) j=pickW();
    const A=Math.min(i,j), B=Math.max(i,j);
    pools.quin[`${A}-${B}`]=(pools.quin[`${A}-${B}`]||0)+add();
    pools.placeq[`${A}-${B}`]=(pools.placeq[`${A}-${B}`]||0)+Math.floor(add()*0.7);
    pools.exact[`${i}>${j}`]=(pools.exact[`${i}>${j}`]||0)+Math.floor(add()*0.6);
  }
  if (Math.random()<0.6){
    const picks=pickNWeighted(3,weights);
    pools.trio[sortedKey(...picks)]=(pools.trio[sortedKey(...picks)]||0)+Math.floor(add()*0.8);
    if (Math.random()<0.5) pools.trifecta[`${picks[0]}>${picks[1]}>${picks[2]}`]=(pools.trifecta[`${picks[0]}>${picks[1]}>${picks[2]}`]||0)+Math.floor(add()*0.5);
  }
}
function weightedPick(ws){ const s=ws.reduce((a,b)=>a+b,0); let r=Math.random()*s; for(let i=0;i<ws.length;i++){ r-=ws[i]; if(r<0) return i; } return ws.length-1; }
function pickNWeighted(n,ws){ const idx=[]; const t=ws.slice(); for(let k=0;k<n;k++){ const i=weightedPick(t); idx.push(i); t[i]=0; } return idx; }

/* ===== ë°°ë‹¹/ì •ì‚°/í‘œ ===== */
function makePools(roster){
  const weights=roster.map(r=>Math.pow(r.rating,1.9));
  const wsum=weights.reduce((a,b)=>a+b,0);
  const base={ win:90000, place:70000, quin:140000, exact:120000, placeq:90000, trio:120000, trifecta:100000 };
  const win=roster.map((r,i)=>({key:`H${i}`, amount:Math.max(1000,(weights[i]/wsum)*base.win*rand(0.8,1.2))}));
  const place=roster.map((r,i)=>({key:`P${i}`, amount:Math.max(1000,(weights[i]/wsum)*base.place*rand(0.9,1.2))}));
  const quin={}, exact={}, placeq={}, trio={}, trifecta={};
  for(let i=0;i<roster.length;i++){
    for(let j=i+1;j<roster.length;j++){
      const w=weights[i]*weights[j];
      quin[`${i}-${j}`]=Math.max(500,(w/(wsum*wsum))*base.quin*rand(0.8,1.3));
      placeq[`${i}-${j}`]=Math.max(400,(w/(wsum*wsum))*base.placeq*rand(0.9,1.2));
    }
  }
  for(let i=0;i<roster.length;i++){
    for(let j=0;j<roster.length;j++){
      if(i===j) continue;
      const w=weights[i]*weights[j]*1.1;
      exact[`${i}>${j}`]=Math.max(300,(w/(wsum*wsum))*base.exact*rand(0.8,1.3));
    }
  }
  for(let i=0;i<roster.length;i++){
    for(let j=i+1;j<roster.length;j++){
      for(let k=j+1;k<roster.length;k++){
        const w=weights[i]*weights[j]*weights[k];
        trio[`${i}-${j}-${k}`]=Math.max(200,(w/(wsum**3))*base.trio*rand(0.8,1.3));
      }
    }
  }
  for(let i=0;i<roster.length;i++){
    for(let j=0;j<roster.length;j++){
      for(let k=0;k<roster.length;k++){
        if(i===j||i===k||j===k) continue;
        const w=weights[i]*weights[j]*weights[k]*1.1;
        trifecta[`${i}>${j}>${k}`]=Math.max(150,(w/(wsum**3))*base.trifecta*rand(0.8,1.3));
      }
    }
  }
  return {win,place,quin,exact,placeq,trio,trifecta};
}
function computePayouts(order){
  const first=order[0], second=order[1], third=order[2];
  const sumObj=o=>Object.values(o).reduce((a,b)=>a+b,0);

  const winTotal = pools.win.reduce((a,b)=>a+b.amount,0);
  const winRate  = (winTotal*(1-TAKE))/(pools.win[first].amount||0.001);

  const placeTotal = pools.place.reduce((a,b)=>a+b.amount,0);
  const p1 = (placeTotal*(1-TAKE)/3)/(pools.place[first].amount||0.001);
  const p2 = (placeTotal*(1-TAKE)/3)/(pools.place[second].amount||0.001);
  const p3 = (placeTotal*(1-TAKE)/3)/(pools.place[third].amount||0.001);

  const quinTotal = sumObj(pools.quin);
  const keyQ = first<second?`${first}-${second}`:`${second}-${first}`;
  const quinRate = (quinTotal*(1-TAKE))/(pools.quin[keyQ]||0.001);

  const exactTotal = sumObj(pools.exact);
  const keyE = `${first}>${second}`;
  const exactRate = (exactTotal*(1-TAKE))/(pools.exact[keyE]||0.001);

  const pqTotal = sumObj(pools.placeq);
  const keysPQ = [
    first<second?`${first}-${second}`:`${second}-${first}`,
    first<third?`${first}-${third}`:`${third}-${first}`,
    second<third?`${second}-${third}`:`${third}-${second}`
  ];
  const pqOn = keysPQ.reduce((s,k)=>s+(pools.placeq[k]||0),0)||0.001;
  const pqRate = (pqTotal*(1-TAKE))/pqOn;

  const trioTotal = sumObj(pools.trio);
  const keyT = sortedKey(first,second,third);
  const trioRate = (trioTotal*(1-TAKE))/(pools.trio[keyT]||0.001);

  const trifTotal = sumObj(pools.trifecta);
  const keyTf = `${first}>${second}>${third}`;
  const trifRate = (trifTotal*(1-TAKE))/(pools.trifecta[keyTf]||0.001);

  return { win:winRate, place:[p1,p2,p3], quin:quinRate, exact:exactRate, placeq:pqRate, trio:trioRate, trifecta:trifRate };
}
function showPayouts(pay, order){
  const first=order[0], second=order[1], third=order[2];
  const nm=i=>`#${roster[i].no}`;
  payoutsEl.innerHTML = `
    <div class="row small">
      <div class="tag">ë‹¨ìŠ¹ì‹ ${nm(first)}</div><div class="odds">${fmtOdds(pay.win)}</div>
      <div class="tag">ì—°ìŠ¹ì‹ ${nm(first)}</div><div class="odds">${fmtOdds(pay.place[0])}</div>
      <div class="tag">ì—°ìŠ¹ì‹ ${nm(second)}</div><div class="odds">${fmtOdds(pay.place[1])}</div>
      <div class="tag">ì—°ìŠ¹ì‹ ${nm(third)}</div><div class="odds">${fmtOdds(pay.place[2])}</div>
    </div>
    <div class="row small" style="margin-top:6px;">
      <div class="tag">ë³µìŠ¹ì‹ ${nm(first)}-${nm(second)}</div><div class="odds">${fmtOdds(pay.quin)}</div>
      <div class="tag">ìŒìŠ¹ì‹ ${nm(first)}>${nm(second)}</div><div class="odds">${fmtOdds(pay.exact)}</div>
    </div>
    <div class="row small" style="margin-top:6px;">
      <div class="tag">ë³µì—°ìŠ¹ì‹ (Top3 ì„ì˜ 2ë‘)</div><div class="odds">${fmtOdds(pay.placeq)}</div>
      <div class="tag">ì‚¼ë³µìŠ¹ì‹ (Top3 ë¬´ìˆœ)</div><div class="odds">${fmtOdds(pay.trio)}</div>
      <div class="tag">ì‚¼ìŒìŠ¹ì‹ ${nm(first)}>${nm(second)}>${nm(third)}</div><div class="odds">${fmtOdds(pay.trifecta)}</div>
    </div>
  `;
}
function renderPayoutDetails(pay, order) {
  const first=order[0], second=order[1], third=order[2];
  const nm=i=>`#${roster[i].no}`;
  const r=(x)=> (isFinite(x)? x : null);
  const won100 =(od)=> (od ? Math.floor(od*100) : null);
  const won1000=(od)=> (od ? Math.floor(od*1000) : null);

  const rows = [
    { name:`ë‹¨ìŠ¹ ${nm(first)}`, od:r(pay.win) },
    { name:`ì—°ìŠ¹ ${nm(first)}`, od:r(pay.place[0]) },
    { name:`ì—°ìŠ¹ ${nm(second)}`, od:r(pay.place[1]) },
    { name:`ì—°ìŠ¹ ${nm(third)}`, od:r(pay.place[2]) },
    { name:`ë³µìŠ¹ ${nm(first)}-${nm(second)}`, od:r(pay.quin) },
    { name:`ìŒìŠ¹ ${nm(first)}>${nm(second)}`, od:r(pay.exact) },
    { name:`ë³µì—° (Top3 ì„ì˜ 2ë‘)`, od:r(pay.placeq) },
    { name:`ì‚¼ë³µ (Top3 ë¬´ìˆœ)`, od:r(pay.trio) },
    { name:`ì‚¼ìŒ ${nm(first)}>${nm(second)}>${nm(third)}`, od:r(pay.trifecta) },
  ];

  const html = `
    <div class="hr"></div>
    <table style="width:100%;border-collapse:collapse;font-size:12px">
      <thead><tr>
        <th style="text-align:left;padding:4px 6px;">ì¢…ëª©</th>
        <th style="padding:4px 6px;">ë°°ë‹¹ë¥ </th>
        <th style="padding:4px 6px;">100ì› ê¸°ì¤€</th>
        <th style="padding:4px 6px;">1,000ì› ê¸°ì¤€</th>
      </tr></thead>
      <tbody>
        ${rows.map(row=>{
          const od=row.od, w100=won100(od), w1000=won1000(od);
          return `<tr>
            <td style="text-align:left;padding:4px 6px;">${row.name}</td>
            <td style="padding:4px 6px;">${od? od.toFixed(1) : '-'}</td>
            <td style="padding:4px 6px;">${w100!=null? `${w100.toLocaleString()}ì›` : '-'}</td>
            <td style="padding:4px 6px;">${w1000!=null? `${w1000.toLocaleString()}ì›` : '-'}</td>
          </tr>`;
        }).join('')}
      </tbody>
    </table>
  `;
  payoutsEl.innerHTML += html;
}

function renderPoolTotals(){
  const sumObj=o=>Object.values(o).reduce((a,b)=>a+b,0);
  const tWin=pools.win.reduce((a,b)=>a+b.amount,0);
  const tPla=pools.place.reduce((a,b)=>a+b.amount,0);
  const tQuin=sumObj(pools.quin), tEx=sumObj(pools.exact), tPQ=sumObj(pools.placeq), tTrio=sumObj(pools.trio), tTri=sumObj(pools.trifecta);
  poolTotalsEl.innerHTML = `
    <div class="pill small">ë‹¨ìŠ¹í’€ ${fmt(Math.floor(tWin))}ì›</div>
    <div class="pill small">ì—°ìŠ¹í’€ ${fmt(Math.floor(tPla))}ì›</div>
    <div class="pill small">ë³µìŠ¹í’€ ${fmt(Math.floor(tQuin))}ì›</div>
    <div class="pill small">ìŒìŠ¹í’€ ${fmt(Math.floor(tEx))}ì›</div>
    <div class="pill small">ë³µì—°í’€ ${fmt(Math.floor(tPQ))}ì›</div>
    <div class="pill small">ì‚¼ë³µí’€ ${fmt(Math.floor(tTrio))}ì›</div>
    <div class="pill small">ì‚¼ìŒí’€ ${fmt(Math.floor(tTri))}ì›</div>
  `;
}
function renderPayoutPreview(){
  const winTotal=pools.win.reduce((a,b)=>a+b.amount,0);
  const placeTotal=pools.place.reduce((a,b)=>a+b.amount,0);
  roster.forEach((r,i)=>{
    const winOn=pools.win[i].amount||0.001;
    const placeOn=pools.place[i].amount||0.001;
    const winRate=(winTotal*(1-TAKE))/winOn;
    const placeRate=(placeTotal*(1-TAKE)/3)/placeOn;
    const tr=tblBody.children[i]; if(!tr) return;
    tr.querySelector('[data-odds-win]').textContent=Math.max(1,winRate).toFixed(1);
    tr.querySelector('[data-odds-place]').textContent=Math.max(1,placeRate).toFixed(1);
  });
}
function renderTable(){
  tblBody.innerHTML='';
  roster.forEach((r,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><span class="lane" style="background:${r.color}"></span>${r.no}</td>
      <td>${r.name}</td>
      <td>${r.jockey}</td>
      <td>${r.speed}</td>
      <td>${r.stamina}</td>
      <td>${r.burst}</td>
      <td>${r.jockeySkill}</td>
      <td>${r.rating}</td>
      <td class="odds" data-odds-win>-</td>
      <td class="odds" data-odds-place>-</td>
    `;
    tblBody.appendChild(tr);
  });
}
function rebuildTickets(){
  ticketsEl.innerHTML='';
  if (!userTickets.length){ ticketsEl.innerHTML='<div class="hint">ë² íŒ…ì„ ì¶”ê°€í•´ì¤˜. í•˜ë‚˜ì˜ ê²½ì£¼ì— ì—¬ëŸ¬ í‹°ì¼“ ê°€ëŠ¥!</div>'; return; }
  userTickets.forEach((t,idx)=>{
    const div=document.createElement('div'); div.className='ticket row';
    div.innerHTML=`
      <div class="badge">${t.type}</div>
      <div style="flex:1">${descTicket(t)}</div>
      <div><span class="money">${fmt(t.amount)}</span> ì›</div>
      <button class="ghost small" data-del="${idx}">ì‚­ì œ</button>
    `;
    ticketsEl.appendChild(div);
  });
  ticketsEl.querySelectorAll('[data-del]').forEach(btn=>{
    btn.onclick=()=>{
      const i=Number(btn.dataset.del);
      handleWallet(userTickets[i].amount);
      userTickets.splice(i,1); rebuildTickets(); renderPayoutPreview(); renderPoolTotals();
    }
  });
}
function descTicket(t){
  const nm=i=>`${roster[i].no} ${roster[i].name}`;
  if (t.type==='WIN') return `ë‹¨ìŠ¹ì‹: ${nm(t.a)}`;
  if (t.type==='PLACE') return `ì—°ìŠ¹ì‹: ${nm(t.a)}`;
  if (t.type==='QUINELLA') return `ë³µìŠ¹ì‹: ${nm(t.a)} - ${nm(t.b)} (ë¬´ìˆœì„œ)`;
  if (t.type==='EXACTA') return `ìŒìŠ¹ì‹: ${nm(t.a)} > ${nm(t.b)} (ìˆœì„œì¼ì¹˜)`;
  if (t.type==='PLACEQ') return `ë³µì—°ìŠ¹ì‹: ${nm(t.a)} & ${nm(t.b)} (ë‘ ë§ ëª¨ë‘ 3ìœ„ ë‚´)`;
  if (t.type==='TRIO') return `ì‚¼ë³µìŠ¹ì‹: ${nm(t.a)}, ${nm(t.b)}, ${nm(t.c)} (ë¬´ìˆœì„œ)`;
  if (t.type==='TRIFECTA') return `ì‚¼ìŒìŠ¹ì‹: ${nm(t.a)} > ${nm(t.b)} > ${nm(t.c)} (ìˆœì„œì¼ì¹˜)`;
  return '';
}
function addUserPool(type,a,b,amt,c){
  if (type==='WIN') pools.win[a].amount += amt;
  else if (type==='PLACE') pools.place[a].amount += amt;
  else if (type==='QUINELLA') { const key=a<b?`${a}-${b}`:`${b}-${a}`; pools.quin[key]=(pools.quin[key]||0)+amt; }
  else if (type==='EXACTA') { const key=`${a}>${b}`; pools.exact[key]=(pools.exact[key]||0)+amt; }
  else if (type==='PLACEQ') { const key=a<b?`${a}-${b}`:`${b}-${a}`; pools.placeq[key]=(pools.placeq[key]||0)+amt; }
  else if (type==='TRIO') { const key=sortedKey(a,b,c); pools.trio[key]=(pools.trio[key]||0)+amt; }
  else if (type==='TRIFECTA') { const key=`${a}>${b}>${c}`; pools.trifecta[key]=(pools.trifecta[key]||0)+amt; }
}

/* ===== ë“œë¡œì‰ ===== */
function draw(){
  ctx.fillStyle='#0b0e16'; ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.save(); ctx.scale(SCALE,SCALE);

  // ì”ë””/íŠ¸ë™
  ctx.fillStyle='#114a1d';
  ctx.beginPath(); ctx.ellipse(CX, CY, RX+18, RY+18, 0, 0, Math.PI*2); ctx.fill();
  drawTrack();

  // ê±°ë¦¬ í‘œì§€
  [800,1000,1100,1200,1400,1500].forEach(m=>{
    const ang = normAngle(FINISH_ANG - 2*Math.PI*(m/lapMeters));
    drawDistanceSign(ang, m);
  });

  drawFinishPost(FINISH_ANG);
  if (phase==='betting'||phase==='closing'||phase==='parade') drawGate(startAng);

  // ë§
  const N=roster.length;
  roster.forEach((r,idx)=>{
    let ang = (phase==='parade') ? startAng + Math.sin((performance.now()/120)+idx)*0.02
                                  : angleFromDist(r.dist);
    const laneOffset=(idx - (N-1)/2) * 1.8;
    const {x,y} = ovalOffsetPos(ang, laneOffset);

    drawHorseSprite(Math.round(x)-8, Math.round(y)-6, r.color);
    px(Math.round(x)-1, Math.round(y)-8, 6, 4, '#0b0e16');
    tinyText(String(r.no%10), Math.round(x)+2, Math.round(y)-6, '#ffffff');
    if (!r.finished && r.stumble>0) px(Math.round(x)-3, Math.round(y)+2, 2, 2, '#ff9e9e');
  });

  // HUD
  smallText(phase==='parade'?'ì¶œë°œ ì¤€ë¹„':phase==='running'?'RACE RUNNING':phase==='betting'?'BETTING OPEN':phase==='closing'?'CLOSING':phase==='intermission'?'INTERMISSION':'RESULT', 6, 8, '#c8d0ff');
  if (phase==='intermission') smallText(intermissionHint, 6, 16, '#9df7c7');
  // ë‚ ì”¨ ì•„ì´ì½˜
  smallText(`${weather.icon}`, W-16, 16, '#c8d0ff');
  smallText(`${raceMeters}m`, W-36, 8, '#ffd26e');

  ctx.restore();
}
function drawTrack(){
  ctx.fillStyle='#7a3e1d';
  ctx.beginPath(); ctx.ellipse(CX, CY, RX, RY, 0, 0, Math.PI*2); ctx.fill();
  ctx.fillStyle='#0e6a2b';
  ctx.beginPath(); ctx.ellipse(CX, CY, RX-LANE_W, RY-LANE_W, 0, 0, Math.PI*2); ctx.fill();
  ctx.globalCompositeOperation='destination-over';
  ctx.fillStyle='#0f5c26';
  ctx.beginPath(); ctx.ellipse(CX, CY, RX+6, RY+6, 0, 0, Math.PI*2); ctx.fill();
  ctx.globalCompositeOperation='source-over';
  ctx.strokeStyle='#ffffff'; ctx.lineWidth=1;
  ctx.beginPath(); ctx.ellipse(CX, CY, RX-2, RY-2, 0, 0, Math.PI*2); ctx.stroke();
  ctx.beginPath(); ctx.ellipse(CX, CY, RX-LANE_W+2, RY-LANE_W+2, 0, 0, Math.PI*2); ctx.stroke();
}
function drawFinishPost(ang){
  const p=ovalOffsetPos(ang, -6);
  px(p.x-1, p.y-14, 3, 14, '#e63946');
  ctx.fillStyle='#e63946'; ctx.beginPath(); ctx.arc(p.x+0.5, p.y-16, 5, 0, Math.PI*2); ctx.fill();
  ctx.fillStyle='#ffffff'; ctx.beginPath(); ctx.arc(p.x+0.5, p.y-16, 3, 0, Math.PI*2); ctx.fill();
}
function drawGate(ang){
  const p=ovalOffsetPos(ang, -4);
  px(p.x-6, p.y-8, 12, 8, '#2b4c7e');
  px(p.x-7, p.y-2, 14, 2, '#20395e');
  px(p.x-4, p.y-8, 1, 8, '#0e2340');
  px(p.x,   p.y-8, 1, 8, '#0e2340');
  px(p.x+4, p.y-8, 1, 8, '#0e2340');
}
function drawDistanceSign(ang, m){
  const p=ovalOffsetPos(ang, 14);
  px(p.x-8, p.y-10, 16, 8, '#ff6b6b'); tinyText(String(m), p.x, p.y-6, '#ffffff', 'center');
  px(p.x-1, p.y-10, 2, 10, '#c0392b');
}
function px(x,y,w,h,color){ ctx.fillStyle=color; ctx.fillRect(x,y,w,h); }
function smallText(str,x,y,color){ ctx.fillStyle=color; ctx.font='7px monospace'; ctx.textAlign='left'; ctx.textBaseline='top'; ctx.fillText(str,x,y); }
function tinyText(str,x,y,color,align='center'){ ctx.fillStyle=color; ctx.font='6px monospace'; ctx.textAlign=align; ctx.textBaseline='middle'; ctx.fillText(str,x,y); }
const HORSE_SPR=["....BBBBBBBB....","...BBBBBBBBBB...","..BBBBBBBBBBBB..","..BBBBBYYBBBBB..",".BBBBBYYYYBBBBB.",".BBBBBBBBBBBBBB.",".BBBBBBBBBBBBBB.","..BB..BB..BB..B.","...B..BB..BB...."];
const JOCKEY_SPR=["..WW.",".WGW.",".WWW.","..W.."];
function drawHorseSprite(x,y,color){
  for(let j=0;j<HORSE_SPR.length;j++) for(let i=0;i<HORSE_SPR[j].length;i++){
    const c=HORSE_SPR[j][i];
    if(c==='B') px(x+i,y+j,1,1,color);
    else if(c==='Y') px(x+i,y+j,1,1,'#2a1a0a');
  }
  for(let j=0;j<JOCKEY_SPR.length;j++) for(let i=0;i<JOCKEY_SPR[j].length;i++){
    const c=JOCKEY_SPR[j][i];
    if(c==='W') px(x+3+i,y-4+j,1,1,'#ffeaa7');
    else if(c==='G') px(x+3+i,y-4+j,1,1,'#6C5CE7');
  }
}

/* ===== ì¢Œí‘œ/ë³´ì¡° ===== */
function ovalOffsetPos(theta, offset){
  const px0=RX*Math.cos(theta), py0=RY*Math.sin(theta);
  const tx=-RX*Math.sin(theta), ty=RY*Math.cos(theta); let nx=ty, ny=-tx;
  const len=Math.hypot(nx,ny)||1; nx/=len; ny/=len;
  return { x: CX + px0 + nx*offset, y: CY + py0 + ny*offset };
}
function angleFromDist(dist){ return normAngle(FINISH_ANG - 2*Math.PI*(raceMeters/lapMeters) + (2*Math.PI)*(dist/lapMeters)); }
function normAngle(a){ while(a<=-Math.PI) a+=2*Math.PI; while(a>Math.PI) a-=2*Math.PI; return a; }
function syncControls(){
  const canBet=(phase==='betting'||phase==='closing');
  [btnAdd,selType,pickA,pickB,pickC,amount].forEach(el=>el.disabled=!canBet);
  const canStart=!(phase==='running'||phase==='result'||phase==='parade'||phase==='intermission');
  btnStart.disabled=!canStart;
}
function renderHistory(){
  if (!history.length){ historyEl.innerHTML='<div class="hint">ì•„ì§ ê¸°ë¡ì´ ì—†ì–´ìš”.</div>'; return; }
  historyEl.innerHTML = history.map(h=>{
    const sign=h.pnl>=0?'color:var(--good)':'color:var(--bad)';
    return `<div class="row small">
      <div class="pill">R${h.raceNo}</div>
      <div>${h.time}</div>
      <div>${h.meters||'?'}m / ${h.field||'?'}ë‘</div>
      <div>1-3ìœ„: #${(h.order[0]??-1)+1} / #${(h.order[1]??-1)+1} / #${(h.order[2]??-1)+1}</div>
      <div>ë² íŒ… ${fmt(h.totalBet||0)}ì› â†’ í™˜ê¸‰ ${fmt(h.totalReturn||0)}ì›</div>
      <div style="${sign}">ì†ìµ ${fmt(h.pnl||0)}ì›</div>
    </div>`;
  }).join('');
}

/* ===== ìœ í‹¸ ===== */
function map(v,inMin,inMax,outMin,outMax){ return outMin + (v-inMin)*(outMax-outMin)/(inMax-inMin); }

})();
</script>

<!-- Firebase ëª¨ë“ˆ(ë¡œê·¸ì¸/ìë™ ì˜êµ¬ ë¡œê·¸ì¸ + ë¡œê·¸ì•„ì›ƒ í™•ì‹¤í™” + ì¶©ì „í•˜ê¸°) -->
<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js';
  import {
    getAuth, onAuthStateChanged, createUserWithEmailAndPassword,
    signInWithEmailAndPassword, signOut, setPersistence, browserLocalPersistence
  } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js';
  import {
    getFirestore, doc, getDoc, setDoc, updateDoc,
    serverTimestamp, enableIndexedDbPersistence, increment, onSnapshot
  } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js';
  import { getFunctions, httpsCallable } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-functions.js';

  const firebaseConfig = {
    apiKey: "AIzaSyCDAkMPPoAKYZj4dS74eLJM0fuko_tcvhE",
    authDomain: "authentication-2a265.firebaseapp.com",
    projectId: "authentication-2a265",
    storageBucket: "authentication-2a265.firebasestorage.app",
    messagingSenderId: "710116433234",
    appId: "1:710116433234:web:7d0e4ba9ddd1b13be72e8b",
    measurementId: "G-MTKTT6KRVP"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  await setPersistence(auth, browserLocalPersistence); // ì˜êµ¬ ë¡œê·¸ì¸ ìœ ì§€
  const db   = getFirestore(app);
  const functions = getFunctions(app); // ë¦¬ì „ì„ ë³€ê²½í–ˆë‹¤ë©´ getFunctions(app, 'asia-northeast3')
  try { await enableIndexedDbPersistence(db); } catch(_) {}

  // DOM
  const emailEl    = document.getElementById('email');
  const passwordEl = document.getElementById('password');
  const btnSignup  = document.getElementById('btnSignup');
  const btnLogin   = document.getElementById('btnLogin');
  const btnLogout  = document.getElementById('btnLogout');
  const authHint   = document.getElementById('authHint');

  const btnDaily   = document.getElementById('btnDaily');
  const dailyHint  = document.getElementById('dailyHint');
  const btnCoupon  = document.getElementById('btnCoupon');
  const couponInput= document.getElementById('couponInput');
  const couponHint = document.getElementById('couponHint');

  let uid = null;
  let localWallet = Number(localStorage.getItem('wallet') || 100000);
  if (!Number.isFinite(localWallet) || localWallet <= 0) localWallet = 100000;

  window.firebaseWallet = {
    add: async (delta) => {
      if (!uid) {
        localWallet = Math.max(0, localWallet + delta);
        localStorage.setItem('wallet', localWallet);
        window.gameWallet?.setFromCloud(localWallet);
        return;
      }
      const ref = doc(db, 'users', uid);
      await updateDoc(ref, { wallet: increment(delta), updatedAt: serverTimestamp() })
        .catch(async () => {
          await setDoc(ref, { wallet: localWallet ?? 100000, updatedAt: serverTimestamp() }, { merge: true });
          await updateDoc(ref, { wallet: increment(delta), updatedAt: serverTimestamp() });
        });
    },
    set: async (value) => {
      if (!uid) {
        localWallet = Math.max(0, Number(value)||0);
        localStorage.setItem('wallet', localWallet);
        window.gameWallet?.setFromCloud(localWallet);
        return;
      }
      const ref = doc(db, 'users', uid);
      await setDoc(ref, { wallet: Math.max(0, Number(value)||0), updatedAt: serverTimestamp() }, { merge: true });
    },
    get: () => localWallet
  };

  // ì„œë²„ í•¨ìˆ˜
  const callDaily  = httpsCallable(functions, 'walletTopupDaily');   // í•˜ë£¨ 1íšŒ 10,000ì›
  const callCoupon = httpsCallable(functions, 'walletRedeemCoupon'); // ì¿ í° {amount} ì§€ê¸‰

  // ë¡œê·¸ì¸ ìƒíƒœ ê°ì‹œ + ì§€ê°‘ ì‹¤ì‹œê°„ êµ¬ë…
  let unsubWallet = null;
  onAuthStateChanged(auth, async (user) => {
    if (unsubWallet) { unsubWallet(); unsubWallet = null; }

    if (user) {
      uid = user.uid;
      btnLogout.style.display = '';
      btnLogin.style.display  = 'none';
      btnSignup.style.display = 'none';
      emailEl.style.display   = 'none';
      passwordEl.style.display= 'none';
      authHint.textContent    = `${user.email} ë¡œê·¸ì¸ë¨`;
      btnDaily.disabled = false; btnCoupon.disabled = false;

      const ref = doc(db, 'users', uid);
      const snap = await getDoc(ref);
      if (!snap.exists()) {
        await setDoc(ref, { wallet: localWallet ?? 100000, updatedAt: serverTimestamp() }, { merge: true });
      }
      unsubWallet = onSnapshot(ref, (s) => {
        const data = s.data() || {};
        if (typeof data.wallet === 'number') {
          localWallet = data.wallet;
          localStorage.setItem('wallet', localWallet);
          window.gameWallet?.setFromCloud(localWallet);
        }
      });

      updateDailyHintClient();
    } else {
      uid = null;
      btnLogout.style.display = 'none';
      btnLogin.style.display  = '';
      btnSignup.style.display = '';
      emailEl.style.display   = '';
      passwordEl.style.display= '';
      authHint.textContent    = 'ì´ë©”ì¼/ë¹„ë²ˆ ë¡œê·¸ì¸í•˜ë©´ ì§€ê°‘ì´ í´ë¼ìš°ë“œì— ì €ì¥ë¼ìš”.';
      btnDaily.disabled = true; btnCoupon.disabled = true;
      window.gameWallet?.setFromCloud(localWallet);
      dailyHint.textContent = 'ë¡œê·¸ì¸í•˜ë©´ ì¶œì„ ë³´ë„ˆìŠ¤ ì´ìš© ê°€ëŠ¥';
    }
  });

  // ì¶œì„ ë³´ë„ˆìŠ¤: ì„œë²„ ìš°ì„ (10,000ì›)
  btnDaily.onclick = async () => {
    if (!uid) return alert('ë¡œê·¸ì¸í•´ì¤˜!');
    try {
      const res = await callDaily({});
      if (res.data?.ok) {
        dailyHint.textContent = 'ì§€ê¸‰ ì™„ë£Œ! ì ì‹œ í›„ ì”ì•¡ì´ ë°˜ì˜ë¼ìš”.';
      }
    } catch (e) {
      // í•„ìš” ì‹œ í…ŒìŠ¤íŠ¸ìš© í´ë°±(ìš´ì˜ì—ì„  ì œê±° ê¶Œì¥)
      try { await claimDailyClient(); }
      catch (e2){ alert(e.message || e2.message || 'ë³´ë„ˆìŠ¤ ìˆ˜ë ¹ ì‹¤íŒ¨'); }
    }
  };

  // ì¿ í° ì‚¬ìš©(ì˜ˆ: coupons/TEST10K {amount:10000,active:true})
  btnCoupon.onclick = async () => {
    if (!uid) return alert('ë¡œê·¸ì¸í•´ì¤˜!');
    const code = (couponInput.value||'').trim();
    if (!code) return alert('ì¿ í° ì½”ë“œë¥¼ ì…ë ¥í•´ì¤˜!');
    try {
      const res = await callCoupon({ code });
      if (res.data?.ok) {
        couponHint.textContent = 'ì¿ í° ì§€ê¸‰ ì™„ë£Œ! ì”ì•¡ì´ ë°˜ì˜ë¼ìš”.';
        couponInput.value = '';
      } else {
        alert('ì¿ í° ì‹¤íŒ¨');
      }
    } catch (e) {
      alert(e.message || 'ì¿ í° ì‹¤íŒ¨');
    }
  };

  // ë¡œê·¸ì•„ì›ƒ: ì¦‰ì‹œ ë°˜ì˜(ì˜êµ¬ ë¡œê·¸ì¸ í•´ì œ + ìƒˆë¡œê³ ì¹¨)
  btnLogout.onclick = async () => {
    try {
      await signOut(auth);
      localStorage.removeItem('wallet');
      location.replace(location.pathname + '?v=logout');
    } catch(_) {}
  };

  // í´ë¼ì´ì–¸íŠ¸ í´ë°±(í…ŒìŠ¤íŠ¸ìš©): 10,000ì›
  async function claimDailyClient(){
    const ref = doc(db, 'users', uid);
    const snap = await getDoc(ref);
    const data = snap.data() || {};
    const last = data.lastClaimAt?.toMillis?.() || 0;
    const now  = Date.now();
    const DAY  = 24*60*60*1000;
    const left = Math.max(0, DAY - (now - last));
    if (left > 0) {
      const h = Math.ceil(left/3600000);
      dailyHint.textContent = `ë‹¤ìŒ ë³´ë„ˆìŠ¤ê¹Œì§€ ì•½ ${h}ì‹œê°„`;
      throw new Error('ì•„ì§ 24ì‹œê°„ì´ ì•ˆ ì§€ë‚¬ì–´');
    }
    await window.firebaseWallet.add(10000);
    await setDoc(ref, { lastClaimAt: serverTimestamp(), updatedAt: serverTimestamp() }, { merge: true });
    dailyHint.textContent = 'ì§€ê¸‰ ì™„ë£Œ!';
  }
  function updateDailyHintClient(){ dailyHint.textContent = 'í•˜ë£¨ 1íšŒ 10,000ì› ì§€ê¸‰'; }
</script>
</body>
</html>
