<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>도트 경마 v3 - 풀 기능 + 안정화</title>
<style>
  :root {
    --bg:#0b0e16; --panel:#0f1424; --line:#1f2940; --text:#c8d0ff; --title:#ffffff;
    --accent:#6C5CE7; --good:#9df7c7; --warn:#ffd26e; --bad:#ff7a9e;
  }
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
  .wrap{max-width:1100px;margin:0 auto;padding:14px}
  h1{margin:0 0 10px;color:var(--title);font-size:20px}
  .grid{display:grid;grid-template-columns:560px 1fr;gap:12px}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:10px;padding:10px}
  canvas{width:100%;height:auto;display:block;image-rendering:pixelated;border-radius:8px;border:1px solid var(--line)}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .row>*{flex:1 1 auto}
  .pill{padding:4px 10px;border-radius:999px;background:#131a33;border:1px solid var(--line);font-size:12px}
  .money{font-weight:700;color:var(--warn)}
  button{background:var(--accent);color:#fff;border:0;border-radius:8px;padding:8px 12px;cursor:pointer}
  button.secondary{background:#1e2a53;color:#dbe1ff}
  button.ghost{background:transparent;border:1px solid var(--line);color:var(--text)}
  button:disabled{opacity:.6;cursor:not-allowed}
  select,input[type=number]{width:100%;background:#0d1330;color:var(--text);border:1px solid var(--line);border-radius:8px;padding:6px 8px}
  table{width:100%;border-collapse:collapse;font-size:12px}
  th,td{border-bottom:1px dashed var(--line);padding:6px 8px;text-align:center;white-space:nowrap}
  th{color:#9fb0ff}
  .badge{display:inline-block;padding:2px 6px;border-radius:999px;font-size:11px;border:1px solid var(--line);background:#111729}
  .lane{display:inline-block;width:16px;height:16px;border-radius:4px;margin-right:6px;vertical-align:middle}
  .ticket{background:#0e1531;border:1px solid var(--line);padding:8px;border-radius:8px;margin:6px 0;font-size:12px}
  .small{font-size:12px}
  .right{text-align:right}
  .hint{font-size:12px;opacity:.75;margin-top:6px}
  .odds{font-variant-numeric:tabular-nums}
  .flex{display:flex;gap:8px;align-items:center}
  .nowrap{white-space:nowrap}
  .hr{height:1px;background:var(--line);margin:8px 0}
  .history{font-size:12px}
  .tag{display:inline-block;padding:2px 6px;border-radius:6px;border:1px solid var(--line);background:#141a33}
</style>
</head>
<body>
<div class="wrap">
  <h1>도트 경마 v3</h1>
  <div class="grid">
    <div class="panel">
      <canvas id="game"></canvas>

      <div class="row" style="margin-top:8px;">
        <button id="btnNew" class="secondary">다음 경주 편성</button>
        <button id="btnStart">출발!</button>
        <div class="pill">경주번호 <span id="raceNo">1</span></div>
        <div class="pill">상태 <span id="phaseText">베팅 오픈</span> · 마감까지 <span id="countdown">--</span>s</div>
        <div class="pill">지갑 <span id="wallet" class="money">0</span> 원</div>
      </div>
      <div class="hint">컨디션은 비공개. 출발 전까지 AI 베팅 유입으로 배당이 실시간 변동돼요.</div>
    </div>

    <div class="panel">
      <div class="row">
        <div class="pill">테이크아웃 18%</div>
        <div class="pill">출전 <span id="fieldSize">-</span>두</div>
        <div class="pill">예상 배당은 현재 풀 기준</div>
      </div>
      <div class="hr"></div>

      <table id="tbl">
        <thead>
          <tr>
            <th>번</th><th>마명</th><th>기수</th>
            <th>산지</th><th>성별</th><th>연령</th><th>중량</th>
            <th>속력</th><th>지구력</th><th>스퍼트</th><th>숙련</th><th>레이팅</th>
            <th>단승</th><th>연승</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="hr"></div>

      <div class="row">
        <select id="betType">
          <option value="WIN">단승식 (1착)</option>
          <option value="PLACE">연승식 (3위 내)</option>
          <option value="QUINELLA">복승식 (1·2착 무순)</option>
          <option value="EXACTA">쌍승식 (1·2착 순서일치)</option>
          <option value="PLACEQ">복연승식 (두 말 모두 3위 내)</option>
          <option value="TRIO">삼복승식 (1~3착 무순)</option>
          <option value="TRIFECTA">삼쌍승식 (1~3착 순서일치)</option>
        </select>
        <input id="pickA" type="number" min="1" value="1" placeholder="말1" />
        <input id="pickB" type="number" min="1" value="2" placeholder="말2(필요시)" />
        <input id="pickC" type="number" min="1" value="3" placeholder="말3(필요시)" />
        <input id="amount" type="number" min="100" step="100" value="1000" />
        <button id="btnAdd">베팅 추가</button>
      </div>
      <div class="hint">단/연: 말1 · 복/쌍/복연: 말1, 말2 · 삼복/삼쌍: 말1~말3</div>

      <div id="tickets"></div>
    </div>
  </div>

  <div class="panel" style="margin-top:12px;">
    <div class="row">
      <div class="pill">결과</div>
      <div id="resultText"></div>
    </div>
    <div id="payouts" class="small" style="margin-top:8px;"></div>
    <div id="commentary" class="small" style="margin-top:8px;opacity:.9"></div>
  </div>

  <div class="panel" style="margin-top:12px;">
    <div class="row">
      <div class="pill">히스토리</div>
      <div class="pill">최근 10경주</div>
      <div class="pill">총 손익 <span id="roi" class="money">0</span> 원</div>
    </div>
    <div id="history" class="history" style="margin-top:8px;"></div>
  </div>

  <div class="hint">© 도검유트브 — GitHub Pages에 이 파일 하나 업로드 후 티스토리에 iframe으로 임베드하면 끝!</div>
</div>

<script>
(()=> {
// ========================= 상수/도우미 =========================
const TAKE = 0.18;
const HORSES = 12;
const TRACK_LEN = 1100;
const LANE_H = 14;
const SCALE = 3;
const W = 320, H = LANE_H*(HORSES+2);
const COLORS = ['#ff6b6b','#feca57','#1dd1a1','#5f27cd','#54a0ff','#ff9ff3','#48dbfb','#576574','#c8d6e5','#ffaf40','#10ac84','#ee5253'];

const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
canvas.width = W*SCALE; canvas.height = H*SCALE; ctx.imageSmoothingEnabled=false;

const tblBody = document.querySelector('#tbl tbody');
const fieldSizeEl = document.getElementById('fieldSize');
const walletEl = document.getElementById('wallet');
const ticketsEl = document.getElementById('tickets');
const resultEl = document.getElementById('resultText');
const payoutsEl = document.getElementById('payouts');
const raceNoEl = document.getElementById('raceNo');
const phaseText = document.getElementById('phaseText');
const countdownEl = document.getElementById('countdown');
const historyEl = document.getElementById('history');
const roiEl = document.getElementById('roi');
const btnNew = document.getElementById('btnNew');
const btnStart = document.getElementById('btnStart');
const btnAdd = document.getElementById('btnAdd');
const selType = document.getElementById('betType');
const pickA = document.getElementById('pickA');
const pickB = document.getElementById('pickB');
const pickC = document.getElementById('pickC');
const amount = document.getElementById('amount');
const commentaryEl = document.getElementById('commentary');

const rand=(a,b)=>a+Math.random()*(b-a);
const rint=(a,b)=>Math.floor(rand(a,b+1));
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const choice=arr=>arr[Math.floor(Math.random()*arr.length)];
const fmt=v=>v.toLocaleString('ko-KR');
const fmtOdds=v=>isFinite(v)?v.toFixed(1):'-';
const inRange=(v,a,b)=>v>=a&&v<=b;
const sortedKey=(...xs)=>xs.slice().sort((a,b)=>a-b).join('-');

// 이름/부가 정보
const namesA = ['은하','폭풍','달빛','천둥','유니','블레이즈','다크','초신성','스텔라','라이트','제트','린드'];
const namesB = ['스텝','런','윈드','블리츠','애로우','하모니','웨이브','스파크','피닉스','레인','헤일로','스피릿'];
const jockeyA = ['박','김','이','최','정','한','윤','임','장','서','유','문','안','도','노','송'];
const jockeyB = ['현우','지훈','민수','서연','도윤','하준','예린','지호','서윤','태현','시우','하린','보미','유진','가윤','민재'];
const origins = ['한','미','일','호','영','프'];
const genders = ['수','암','거'];
const ages = [3,4,5,6];
const weights = [54.0,54.5,55.0,55.5,56.0];

// 저장 상태
let wallet = Number(localStorage.getItem('wallet')||100000);
let raceNo = Number(localStorage.getItem('raceNo')||1);
let roiTotal = Number(localStorage.getItem('roiTotal')||0);
walletEl.textContent = fmt(wallet);
raceNoEl.textContent = raceNo;
roiEl.textContent = fmt(roiTotal);

// PATCH: 지갑 파라미터/보정/DEV 충전
const params = new URLSearchParams(location.search);
// reset=1 → 기본값으로 초기화
if (params.get('reset') === '1') {
  localStorage.removeItem('wallet');
}
// wallet=숫자 → 시작 지갑 지정
if (params.has('wallet')) {
  const w = parseInt(params.get('wallet'), 10);
  if (Number.isFinite(w)) localStorage.setItem('wallet', Math.max(0, w));
}
// 최종 로드 + 0원/NaN 보정
wallet = Number(localStorage.getItem('wallet')||100000);
if (!Number.isFinite(wallet) || wallet <= 0) wallet = 100000;
localStorage.setItem('wallet', wallet);
walletEl.textContent = fmt(wallet);
// DEV 모드: 지갑 더블클릭 충전
if (params.get('dev') === '1') {
  walletEl.title = '더블클릭: +100,000 충전';
  walletEl.addEventListener('dblclick', () => {
    wallet += 100000;
    walletEl.textContent = fmt(wallet);
    localStorage.setItem('wallet', wallet);
  });
}

// ================ 경주/베팅 상태 ================
let roster = [];
let pools;
let userTickets = [];
let history = JSON.parse(localStorage.getItem('history')||'[]');
renderHistory();

let phase = 'betting'; // betting -> closing -> running -> result
let countdown = 30;
let aiFlowTimer = 0;

let running = false;
let finishedOrder = [];
let time = 0;
let cameraX = 0;
let cameraVX = 0;
let slowmo = 0;

const FIXED = 1000/60;
let last = performance.now();
let acc = 0;

// 초기 편성
newRace();

// =============== 버튼/입력 ===============
btnAdd.onclick = ()=>{
  // closing 단계까지 허용
  if (!(phase==='betting' || phase==='closing')) return alert('지금은 베팅이 마감되었어!');
  const type = selType.value;
  const a = Number(pickA.value)-1;
  const b = Number(pickB.value)-1;
  const c = Number(pickC.value)-1;
  const amt = Math.max(100, Math.floor(Number(amount.value)/100)*100);
  if (!amt || wallet<amt) return alert('베팅 금액을 확인해줘.');

  if (type==='WIN' || type==='PLACE') {
    if (!inRange(a,0,roster.length-1)) return alert('말 번호 확인!');
    addUserPool(type,a,null,amt);
    userTickets.push({type,a,amount:amt});
  } else if (type==='QUINELLA' || type==='EXACTA' || type==='PLACEQ') {
    if (!inRange(a,0,roster.length-1)||!inRange(b,0,roster.length-1)||a===b) return alert('두 말 번호 확인!');
    addUserPool(type,a,b,amt);
    userTickets.push({type,a,b,amount:amt});
  } else if (type==='TRIO' || type==='TRIFECTA') {
    if (![a,b,c].every(v=>inRange(v,0,roster.length-1))) return alert('세 말 번호 확인!');
    if (a===b||a===c||b===c) return alert('서로 다른 말로 선택해줘!');
    addUserPool(type,a,b,amt,c);
    userTickets.push({type,a,b,c,amount:amt});
  }
  wallet += -amt; walletEl.textContent = fmt(wallet); localStorage.setItem('wallet', wallet);
  rebuildTickets();
  renderPayoutPreview();
};

function startRace() {
  if (phase === 'running') return;
  phase = 'running';
  phaseText.textContent = '경주 중';
  countdown = 0;
  countdownEl.textContent = '0';
  running = true;
  syncControls();
}

btnStart.onclick = ()=>{ startRace(); };

btnNew.onclick = ()=>{
  if (phase==='running' && !confirm('진행 중인 경주를 포기하고 새 편성할까요?')) return;
  raceNo += 1; raceNoEl.textContent = raceNo; localStorage.setItem('raceNo', raceNo);
  newRace();
};

// =============== 주요 함수 ===============
function newRace(){
  phase='betting'; phaseText.textContent='베팅 오픈'; countdown=30; countdownEl.textContent = countdown;
  running=false; finishedOrder.length=0; resultEl.textContent=''; payoutsEl.innerHTML=''; commentaryEl.innerHTML='';
  userTickets=[]; rebuildTickets();
  time=0; cameraX=0; cameraVX=0; slowmo=0;

  // 편성
  roster = Array.from({length:HORSES}, (_,i)=>{
    const speed = rint(60,99);
    const stamina = rint(55,95);
    const burst = rint(50,98);
    const jockeySkill = rint(60,98);
    const horseCond = rand(0.88,1.12); // 숨김
    const jockeyCond = rand(0.90,1.10); // 숨김
    const name = choice(namesA)+choice(namesB);
    const jockey = choice(jockeyA)+choice(jockeyB);
    const origin = choice(origins);
    const gender = choice(genders);
    const age = choice(ages);
    const weight = choice(weights);
    const rating = Math.round(speed*0.5 + stamina*0.3 + burst*0.15 + jockeySkill*0.2);
    return { no:i+1,color:COLORS[i%COLORS.length],name,jockey,origin,gender,age,weight,
             speed,stamina,burst,jockeySkill,rating,
             horseCond,jockeyCond, x:0,y:LANE_H*(i+1),vx:0,fatigue:1,stumble:0,finished:false,finishTime:null };
  });

  // 표/풀
  renderTable();
  pools = makePools(roster);
  renderPayoutPreview();

  fieldSizeEl.textContent = roster.length;
  syncControls();
}

function renderTable(){
  tblBody.innerHTML='';
  roster.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td><span class="lane" style="background:${r.color}"></span>${r.no}</td>
      <td>${r.name}</td>
      <td>${r.jockey}</td>
      <td>${r.origin}</td>
      <td>${r.gender}</td>
      <td>${r.age}</td>
      <td>${r.weight.toFixed(1)}</td>
      <td>${r.speed}</td>
      <td>${r.stamina}</td>
      <td>${r.burst}</td>
      <td>${r.jockeySkill}</td>
      <td>${r.rating}</td>
      <td class="odds" data-odds-win>-</td>
      <td class="odds" data-odds-place>-</td>
    `;
    tblBody.appendChild(tr);
  });
}

function makePools(roster){
  const weights = roster.map(r=>Math.pow(r.rating,1.9));
  const wsum = weights.reduce((a,b)=>a+b,0);
  const base = {
    win: 90000, place: 70000, quin: 140000, exact: 120000, placeq: 90000, trio: 120000, trifecta: 100000
  };

  const win = roster.map((r,i)=>({key:`H${i}`, amount: Math.max(1000,(weights[i]/wsum)*base.win*rand(0.8,1.2))}));
  const place = roster.map((r,i)=>({key:`P${i}`, amount: Math.max(1000,(weights[i]/wsum)*base.place*rand(0.9,1.2))}));

  const quin = {}, exact={}, placeq={}, trio={}, trifecta={};
  for (let i=0;i<roster.length;i++){
    for (let j=i+1;j<roster.length;j++){
      const w = weights[i]*weights[j];
      quin[`${i}-${j}`] = Math.max(500,(w/(wsum*wsum))*base.quin*rand(0.8,1.3));
      placeq[`${i}-${j}`] = Math.max(400,(w/(wsum*wsum))*base.placeq*rand(0.9,1.2));
    }
  }
  for (let i=0;i<roster.length;i++){
    for (let j=0;j<roster.length;j++){
      if (i===j) continue;
      const w = weights[i]*weights[j]*1.1;
      exact[`${i}>${j}`] = Math.max(300,(w/(wsum*wsum))*base.exact*rand(0.8,1.3));
    }
  }
  for (let i=0;i<roster.length;i++){
    for (let j=i+1;j<roster.length;j++){
      for (let k=j+1;k<roster.length;k++){
        const w = weights[i]*weights[j]*weights[k];
        trio[`${i}-${j}-${k}`] = Math.max(200,(w/(wsum**3))*base.trio*rand(0.8,1.3));
      }
    }
  }
  for (let i=0;i<roster.length;i++){
    for (let j=0;j<roster.length;j++){
      for (let k=0;k<roster.length;k++){
        if (i===j||i===k||j===k) continue;
        const w = weights[i]*weights[j]*weights[k]*1.1;
        trifecta[`${i}>${j}>${k}`] = Math.max(150,(w/(wsum**3))*base.trifecta*rand(0.8,1.3));
      }
    }
  }

  return {win,place,quin,exact,placeq,trio,trifecta};
}

function renderPayoutPreview(){
  // 단/연만 표에 표시
  const winTotal = pools.win.reduce((a,b)=>a+b.amount,0);
  const placeTotal = pools.place.reduce((a,b)=>a+b.amount,0);
  roster.forEach((r,i)=>{
    const winOn = pools.win[i].amount||0.001;
    const placeOn = pools.place[i].amount||0.001;
    const winRate = (winTotal*(1-TAKE))/winOn;
    const placeRate = (placeTotal*(1-TAKE)/3)/placeOn; // 간단화
    const tr = tblBody.children[i];
    if (!tr) return;
    tr.querySelector('[data-odds-win]').textContent = Math.max(1,winRate).toFixed(1);
    tr.querySelector('[data-odds-place]').textContent = Math.max(1,placeRate).toFixed(1);
  });
}

function rebuildTickets(){
  ticketsEl.innerHTML='';
  if (userTickets.length===0){
    ticketsEl.innerHTML='<div class="hint">베팅을 추가해줘. 하나의 경주에 여러 티켓 가능!</div>';
    return;
  }
  userTickets.forEach((t,idx)=>{
    const div=document.createElement('div');
    div.className='ticket flex';
    div.innerHTML=`
      <div class="badge">${t.type}</div>
      <div>${descTicket(t)}</div>
      <div class="right" style="flex:1"></div>
      <div><span class="money">${fmt(t.amount)}</span> 원</div>
      <button class="ghost small" data-del="${idx}">삭제</button>
    `;
    ticketsEl.appendChild(div);
  });
  ticketsEl.querySelectorAll('[data-del]').forEach(btn=>{
    btn.onclick=()=>{
      const i=Number(btn.dataset.del);
      wallet += userTickets[i].amount; walletEl.textContent=fmt(wallet); localStorage.setItem('wallet',wallet);
      userTickets.splice(i,1); rebuildTickets(); renderPayoutPreview();
    };
  });
}

function descTicket(t){
  const nm=i=>`${roster[i].no} ${roster[i].name}`;
  if (t.type==='WIN') return `단승식: ${nm(t.a)}`;
  if (t.type==='PLACE') return `연승식: ${nm(t.a)}`;
  if (t.type==='QUINELLA') return `복승식: ${nm(t.a)} - ${nm(t.b)} (무순서)`;
  if (t.type==='EXACTA') return `쌍승식: ${nm(t.a)} > ${nm(t.b)} (순서일치)`;
  if (t.type==='PLACEQ') return `복연승식: ${nm(t.a)} & ${nm(t.b)} (두 말 모두 3위 내)`;
  if (t.type==='TRIO') return `삼복승식: ${nm(t.a)}, ${nm(t.b)}, ${nm(t.c)} (무순서)`;
  if (t.type==='TRIFECTA') return `삼쌍승식: ${nm(t.a)} > ${nm(t.b)} > ${nm(t.c)} (순서일치)`;
  return '';
}

function addUserPool(type,a,b,amt,c){
  if (type==='WIN') pools.win[a].amount += amt;
  else if (type==='PLACE') pools.place[a].amount += amt;
  else if (type==='QUINELLA') {
    const key = a<b?`${a}-${b}`:`${b}-${a}`; pools.quin[key]=(pools.quin[key]||0)+amt;
  } else if (type==='EXACTA') {
    const key = `${a}>${b}`; pools.exact[key]=(pools.exact[key]||0)+amt;
  } else if (type==='PLACEQ') {
    const key = a<b?`${a}-${b}`:`${b}-${a}`; pools.placeq[key]=(pools.placeq[key]||0)+amt;
  } else if (type==='TRIO') {
    const key = sortedKey(a,b,c); pools.trio[key]=(pools.trio[key]||0)+amt;
  } else if (type==='TRIFECTA') {
    const key = `${a}>${b}>${c}`; pools.trifecta[key]=(pools.trifecta[key]||0)+amt;
  }
}

// =============== 60fps 루프/단계 ===============
requestAnimationFrame(loop);
function loop(ts){
  let delta=ts-last; last=ts; if (delta>250) delta=250;
  acc+=delta;
  while(acc>=FIXED){ update(); acc-=FIXED; }
  draw();
  requestAnimationFrame(loop);
}

function update(){
  // 카운트다운 & AI 유동 배당
  if (phase==='betting' || phase==='closing'){
    aiFlowTimer++;
    if (aiFlowTimer%60===0){ // 1초마다
      if (countdown>0) countdown--; countdownEl.textContent = countdown;
      aiRandomFlow(); renderPayoutPreview();
      if (phase==='betting' && countdown<=10){ phase='closing'; phaseText.textContent='베팅 마감 임박'; syncControls(); }
      if (countdown<=0){ startRace(); }
    }
  }

  if (!running) return;

  // 경주 로직
  time++;
  let leadX = 0;
  roster.forEach(r=>{
    if (r.finished) return;

    const base = (1.6 + r.speed/70) * (1 + (r.jockeySkill-70)/400);
    const cond = r.horseCond*r.jockeyCond;
    const prog = r.x/TRACK_LEN;
    const fatigueDrop = 1 - (prog * (1.2 - r.stamina/100));
    r.fatigue = clamp(fatigueDrop,0.70,1.03);
    const kick = (prog>0.82)?(1+(r.burst/100)*0.38):1;
    const jitter = rand(0.985,1.015);

    if (r.stumble<=0 && Math.random()<0.0117) r.stumble = rint(30,70);
    const stumbleMul = (r.stumble>0)?0.68:1;
    if (r.stumble>0) r.stumble--;

    let v = base*cond*r.fatigue*kick*jitter*stumbleMul;
    if (prog>0.35 && prog<0.55) v *= 0.97;

    r.x += v;
    leadX = Math.max(leadX,r.x);

    if (r.x>=TRACK_LEN){
      r.x=TRACK_LEN; r.finished=true; r.finishTime=time;
      finishedOrder.push(roster.indexOf(r));
      slowmo = 50;
      if (finishedOrder.length===roster.length) finishRace();
    }
  });

  // 카메라 패닝/결승 슬로모션
  const targetCam = mapX(leadX) - 140;
  const finLine = mapX(TRACK_LEN) - 220;
  const aim = Math.min(targetCam, finLine);
  cameraVX += (aim - cameraX)*0.02;
  cameraVX *= 0.85;
  cameraX += cameraVX;

  if (slowmo>0) slowmo--;
}

function aiRandomFlow(){
  // 베팅 오픈/마감 임박: 인기마/인기조합에 추가 베팅
  function push(arr, idx, amt){ arr[idx].amount += amt; }
  const add = ()=> Math.floor(rand(200, 4000));
  // 단/연
  for (let t=0;t<rint(2,5);t++){
    const i = weightedPick(roster.map(r=>r.rating));
    push(pools.win, i, add());
    push(pools.place, i, Math.floor(add()*0.8));
  }
  // 복승/쌍승/복연
  for (let t=0;t<rint(1,3);t++){
    const i = weightedPick(roster.map(r=>r.rating));
    let j = weightedPick(roster.map(r=>r.rating)); while(j===i) j=weightedPick(roster.map(r=>r.rating));
    const A = Math.min(i,j), B = Math.max(i,j);
    const keyU = `${A}-${B}`;
    const keyO = `${i}>${j}`;
    pools.quin[keyU] = (pools.quin[keyU]||0)+add();
    pools.placeq[keyU] = (pools.placeq[keyU]||0)+Math.floor(add()*0.7);
    pools.exact[keyO] = (pools.exact[keyO]||0)+Math.floor(add()*0.6);
  }
  // 삼복/삼쌍
  if (Math.random()<0.6){
    const picks = pickNWeighted(3, roster.map(r=>r.rating));
    const keyT = sortedKey(...picks);
    pools.trio[keyT] = (pools.trio[keyT]||0)+Math.floor(add()*0.8);
    if (Math.random()<0.5){
      const keyTf = `${picks[0]}>${picks[1]}>${picks[2]}`;
      pools.trifecta[keyTf] = (pools.trifecta[keyTf]||0)+Math.floor(add()*0.5);
    }
  }
}
function weightedPick(weights){
  const sum=weights.reduce((a,b)=>a+b,0);
  let r=Math.random()*sum;
  for (let i=0;i<weights.length;i++){ r-=weights[i]; if (r<0) return i; }
  return weights.length-1;
}
function pickNWeighted(n, weights){
  const idxs=[];
  const w=weights.slice();
  for (let k=0;k<n;k++){
    const i = weightedPick(w);
    idxs.push(i);
    w[i]=0;
  }
  return idxs;
}

// =============== 결산/배당 ===============
function finishRace(){
  running=false; phase='result'; phaseText.textContent='결과'; syncControls();
  const order=[...finishedOrder];
  const first=order[0], second=order[1], third=order[2];
  const nm=i=>`${roster[i].no}-${roster[i].name}`;
  resultEl.innerHTML = `<b>도착</b> ▶ 1위 ${nm(first)}  /  2위 ${nm(second)}  /  3위 ${nm(third)}`;

  const pay = computePayouts(order);
  showPayouts(pay, order);

  // 정산
  let totalBet = userTickets.reduce((s,t)=>s+t.amount,0);
  let totalReturn = 0;
  const lines=[];
  userTickets.forEach(t=>{
    const ret = settleTicket(t, order, pay);
    totalReturn += ret;
    lines.push(`• ${descTicket(t)} → ${ret>0?('적중 '+fmt(Math.floor(ret))+'원'):'미적중'}`);
  });
  if (totalReturn>0){ wallet += Math.floor(totalReturn); walletEl.textContent=fmt(wallet); localStorage.setItem('wallet',wallet); }
  const pnl = Math.floor(totalReturn - totalBet);
  roiTotal += pnl; localStorage.setItem('roiTotal', roiTotal); roiEl.textContent = fmt(roiTotal);

  payoutsEl.innerHTML += `<div class="hr"></div><div class="small">${lines.join('<br>')}</div>`;

  // 히스토리 갱신
  history.unshift({
    raceNo, time: new Date().toLocaleString(), order: order.slice(0,3),
    pnl, totalBet, totalReturn
  });
  if (history.length>10) history.pop();
  localStorage.setItem('history', JSON.stringify(history));
  renderHistory();

  // 간단 해설
  const comm = [];
  comm.push(`스타트 직후 선두 쟁탈전! ${nm(first)}가 안쪽 유리한 전개!`);
  comm.push(`코너 통과, ${nm(second)} 추격! 직선에서 ${nm(third)} 스퍼트로 순위 다툼!`);
  commentaryEl.innerHTML = comm.map(s=>`<div>· ${s}</div>`).join('');
}

function computePayouts(order){
  const first=order[0], second=order[1], third=order[2];

  // 단/연
  const winTotal = pools.win.reduce((a,b)=>a+b.amount,0);
  const winOn = pools.win[first].amount||0.001;
  const winRate = (winTotal*(1-TAKE))/winOn;

  const placeTotal = pools.place.reduce((a,b)=>a+b.amount,0);
  const p1 = (placeTotal*(1-TAKE)/3)/(pools.place[first].amount||0.001);
  const p2 = (placeTotal*(1-TAKE)/3)/(pools.place[second].amount||0.001);
  const p3 = (placeTotal*(1-TAKE)/3)/(pools.place[third].amount||0.001);

  // 복승(무순서)
  const kQuin = first<second?`${first}-${second}`:`${second}-${first}`;
  const quinTotal = Object.values(pools.quin).reduce((a,b)=>a+b,0);
  const quinOn = pools.quin[kQuin]||0.001;
  const quinRate = (quinTotal*(1-TAKE))/quinOn;

  // 쌍승(순서)
  const kExact = `${first}>${second}`;
  const exactTotal = Object.values(pools.exact).reduce((a,b)=>a+b,0);
  const exactOn = pools.exact[kExact]||0.001;
  const exactRate = (exactTotal*(1-TAKE))/exactOn;

  // 복연승(Top3 임의 2두)
  const pqTotal = Object.values(pools.placeq).reduce((a,b)=>a+b,0);
  const keysPQ = [
    first<second?`${first}-${second}`:`${second}-${first}`,
    first<third?`${first}-${third}`:`${third}-${first}`,
    second<third?`${second}-${third}`:`${third}-${second}`
  ];
  const pqOn = keysPQ.reduce((s,k)=>s+(pools.placeq[k]||0),0)||0.001;
  const pqRate = (pqTotal*(1-TAKE))/pqOn;

  // 삼복승(무순서)
  const kTrio = sortedKey(first,second,third);
  const trioTotal = Object.values(pools.trio).reduce((a,b)=>a+b,0);
  const trioOn = pools.trio[kTrio]||0.001;
  const trioRate = (trioTotal*(1-TAKE))/trioOn;

  // 삼쌍승(순서)
  const kTrif = `${first}>${second}>${third}`;
  const trifTotal = Object.values(pools.trifecta).reduce((a,b)=>a+b,0);
  const trifOn = pools.trifecta[kTrif]||0.001;
  const trifRate = (trifTotal*(1-TAKE))/trifOn;

  return {
    win:winRate, place:[p1,p2,p3],
    quin:quinRate, exact:exactRate,
    placeq:pqRate, trio:trioRate, trifecta:trifRate
  };
}

function settleTicket(t, order, pay){
  const first=order[0], second=order[1], third=order[2];
  if (t.type==='WIN') return (t.a===first)? t.amount*Math.max(1,pay.win) : 0;
  if (t.type==='PLACE'){
    if (t.a===first) return t.amount*Math.max(1,pay.place[0]);
    if (t.a===second) return t.amount*Math.max(1,pay.place[1]);
    if (t.a===third) return t.amount*Math.max(1,pay.place[2]);
    return 0;
  }
  if (t.type==='QUINELLA'){
    const [i,j] = t.a<t.b?[t.a,t.b]:[t.b,t.a];
    const [fi,fj] = first<second?[first,second]:[second,first];
    return (i===fi&&j===fj)? t.amount*Math.max(1,pay.quin||0) : 0;
  }
  if (t.type==='EXACTA'){
    return (t.a===first && t.b===second)? t.amount*Math.max(1,pay.exact||0) : 0;
  }
  if (t.type==='PLACEQ'){
    const top3 = new Set([first,second,third]);
    return (top3.has(t.a)&&top3.has(t.b))? t.amount*Math.max(1,pay.placeq||0) : 0;
  }
  if (t.type==='TRIO'){
    const key = sortedKey(t.a,t.b,t.c);
    return (key===sortedKey(first,second,third))? t.amount*Math.max(1,pay.trio||0) : 0;
  }
  if (t.type==='TRIFECTA'){
    return (t.a===first&&t.b===second&&t.c===third)? t.amount*Math.max(1,pay.trifecta||0) : 0;
  }
  return 0;
}

function showPayouts(pay, order){
  const first=order[0], second=order[1], third=order[2];
  const nm=i=>`#${roster[i].no}`;
  payoutsEl.innerHTML = `
    <div class="row small">
      <div class="tag">단승식 ${nm(first)}</div><div class="odds">${fmtOdds(pay.win)}</div>
      <div class="tag">연승식 ${nm(first)}</div><div class="odds">${fmtOdds(pay.place[0])}</div>
      <div class="tag">연승식 ${nm(second)}</div><div class="odds">${fmtOdds(pay.place[1])}</div>
      <div class="tag">연승식 ${nm(third)}</div><div class="odds">${fmtOdds(pay.place[2])}</div>
    </div>
    <div class="row small" style="margin-top:6px;">
      <div class="tag">복승식 ${nm(first)}-${nm(second)}</div><div class="odds">${fmtOdds(pay.quin)}</div>
      <div class="tag">쌍승식 ${nm(first)}>${nm(second)}</div><div class="odds">${fmtOdds(pay.exact)}</div>
    </div>
    <div class="row small" style="margin-top:6px;">
      <div class="tag">복연승식 (Top3 임의 2두)</div><div class="odds">${fmtOdds(pay.placeq)}</div>
      <div class="tag">삼복승식 (Top3 무순)</div><div class="odds">${fmtOdds(pay.trio)}</div>
      <div class="tag">삼쌍승식 ${nm(first)}>${nm(second)}>${nm(third)}</div><div class="odds">${fmtOdds(pay.trifecta)}</div>
    </div>
  `;
}

function renderHistory(){
  if (!history || history.length===0){ historyEl.innerHTML='<div class="hint">아직 기록이 없어요.</div>'; return; }
  historyEl.innerHTML = history.map(h=>{
    const sign = h.pnl>=0? 'color:var(--good)':'color:var(--bad)';
    return `<div class="row small">
      <div class="pill">R${h.raceNo}</div>
      <div>${h.time}</div>
      <div>1-3위: #${(h.order[0]??-1)+1} / #${(h.order[1]??-1)+1} / #${(h.order[2]??-1)+1}</div>
      <div>베팅 ${fmt(h.totalBet)}원 → 환급 ${fmt(h.totalReturn)}원</div>
      <div style="${sign}">손익 ${fmt(h.pnl)}원</div>
    </div>`;
  }).join('');
}

// =============== 렌더(연출 포함) ===============
function draw(){
  ctx.fillStyle = '#0b0e16'; ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.save(); ctx.scale(SCALE,SCALE);

  // 트랙 영역
  ctx.fillStyle = '#12203a';
  ctx.fillRect(0, LANE_H*0.5, W, LANE_H*(HORSES+1));
  ctx.strokeStyle = '#203057'; ctx.lineWidth = 1;
  for (let i=1;i<=HORSES;i++){
    const y=LANE_H*i+0.5;
    ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke();
  }

  // 결승선
  const gx = mapX(TRACK_LEN);
  ctx.fillStyle = '#ffffff';
  for (let y=LANE_H*0.5; y<LANE_H*(HORSES+1); y+=4) ctx.fillRect(gx - cameraX, y, 2, 2);

  // 스타팅 게이트
  if (phase==='betting' || phase==='closing'){
    const gateX = mapX(0) - cameraX;
    ctx.fillStyle = '#334e7d';
    ctx.fillRect(gateX-2, LANE_H*0.5, 4, LANE_H*(HORSES+1));
  }

  // 말/기수(도트)
  roster.forEach(r=>{
    const x = mapX(r.x) - cameraX;
    const y = r.y - 7;
    drawHorse(x,y,r.color);
    // 번호 패널
    ctx.fillStyle = '#0b0e16'; ctx.fillRect(x+5, y+2, 6,4);
    ctx.fillStyle = '#ffffff'; ctx.font='4px monospace'; ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText(String(r.no%10), x+8, y+4);
    // 기수 헬멧
    ctx.fillStyle = '#ffeaa7'; ctx.fillRect(x+2, y-2, 3,3);
    // 실수 파티클
    if (!r.finished && r.stumble>0){
      ctx.fillStyle = '#ff9e9e'; ctx.fillRect(x-2,y+3,2,2);
    }
  });

  // 상단 HUD
  ctx.fillStyle = '#c8d0ff'; ctx.font='7px monospace'; ctx.textAlign='left';
  const phaseMsg = phase==='betting'?'BETTING OPEN':phase==='closing'?'CLOSING':phase==='running'?'RACE RUNNING':'RESULT';
  ctx.fillText(phaseMsg, 6, 8);
  ctx.textAlign='right';
  ctx.fillText('Finish ▶', W-6, 8);

  // 결승 슬로모션 오버레이
  if (slowmo>0){
    ctx.fillStyle='rgba(255,255,255,0.05)';
    ctx.fillRect(0,0,W,H);
  }

  ctx.restore();
}

function drawHorse(x,y,color){
  // 간단 실루엣
  ctx.fillStyle=color;
  ctx.fillRect(x, y, 16, 9);              // 몸통
  ctx.fillRect(x-2, y+6, 3, 3);           // 꼬리
  ctx.fillRect(x+12, y+2, 5, 3);          // 목
  ctx.fillRect(x+16, y+1, 2, 2);          // 머리
  // 다리
  ctx.fillRect(x+3, y+9, 2, 3);
  ctx.fillRect(x+7, y+9, 2, 3);
  ctx.fillRect(x+11, y+9, 2, 3);
}

function mapX(d){ const left=12+cameraX; const right=W-12+cameraX; return left + (right-left)*clamp(d/TRACK_LEN,0,1); }

function syncControls(){
  const canBet = (phase==='betting' || phase==='closing');
  btnAdd.disabled = !canBet;
  selType.disabled = !canBet;
  pickA.disabled = !canBet;
  pickB.disabled = !canBet;
  pickC.disabled = !canBet;
  amount.disabled = !canBet;

  const canStart = (phase!=='running' && phase!=='result');
  btnStart.disabled = !canStart;
}

// =========================================================
})();
</script>
</body>
</html>
